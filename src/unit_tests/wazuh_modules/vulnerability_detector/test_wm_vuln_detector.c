/*
 * Copyright (C) 2015-2020, Wazuh Inc.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>
#include <cmocka.h>
#include <stdio.h>

#include "../../wazuh_modules/wmodules.h"
#include "../../headers/shared.h"
#include "mocks_wm_vuln_detector.h"

#define REPORT_CVE_VULDET_POS 0
#define REPORT_CVE_REPORT_POS 1

#define PKG1_POS 0
#define PKG2_POS 1

void wm_vuldet_init(wm_vuldet_t *vuldet);
references *wm_vuldet_extract_advisories(cJSON *advisories);
char *wm_vuldet_build_url(char *pattern, char *value);
int wm_vuldet_compare_pkg(cve_vuln_pkg *Pkg1, cve_vuln_pkg *Pkg2);
int wm_vuldet_add_cve_node(cve_vuln_pkg *newPkg, const char *cve, OSHash *cve_table);
cJSON *wm_vuldet_get_cvss(const char *scoring_vector);
void wm_vuldet_free_agent_software(agent_software *agent);
int wm_vuldet_get_oslinux_info(agent_software *agent);
int wm_vuldet_generate_os_and_kernel_package(sqlite3 *db, agent_software *agent);
int wm_vuldet_report_agent_vulnerabilities(sqlite3 *db, agent_software *agent, wm_vuldet_flags *flags);
int wm_vuldet_discard_kernel_package(agent_software *agent, const char *name, const char *version, const char *arch);
int wm_vuldet_send_agent_report(sqlite3 *db, OSHash *cve_table, agent_software *agents_it, wm_vuldet_flags *flags);

/* setup/teardown */

static int build_test_cve_report(vu_report* report, int add_title, int add_condition, int add_ip, int is_hotfix) {

    if (!report)
        return OS_INVALID;

    if (1 == add_title)
        os_strdup("The CVE title.", report->title);

    if (1 == add_condition)
        os_strdup("Package less than 4.3-2", report->condition);

    if (1 == add_ip)
        os_strdup("192.168.0.125", report->agent_ip);

    os_strdup("CVE-2016-6489", report->cve);
    os_strdup("The CVE description or rationale.", report->rationale);
    os_strdup("2020-03-05 15:15:00 UTC", report->published);
    os_strdup("2020-05-25 15:15:00 UTC", report->updated);
    os_strdup("Pending confirmation", report->state);
    os_strdup("cve@mitre.org", report->assigner);
    os_strdup("4.0", report->cve_version);
    report->pending = 1;
    report->is_hotfix = is_hotfix;
    // Impact
    os_strdup(vu_severities[VU_HIGH], report->severity);
    os_calloc(1, sizeof(cv_scoring_system), report->cvss2);
    os_strdup("2.0", report->cvss2->version);
    os_strdup("AV:N/AC:M/Au:N/C:N/I:N/A:C", report->cvss2->vector_string);
    report->cvss2->impact_score = 6.9;
    report->cvss2->exploitability_score = 8.6;
    report->cvss2->base_score = 7.1;
    os_calloc(1, sizeof(cv_scoring_system), report->cvss3);
    os_strdup("3.0", report->cvss3->version);
    os_strdup("AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H", report->cvss3->vector_string);
    report->cvss3->impact_score = 3.6;
    report->cvss3->exploitability_score = 2.2;
    report->cvss3->base_score = 5.9;
    os_strdup("CWE-502", report->cwe);
    // References
    os_realloc(report->advisories, 2 * sizeof(char *), report->advisories);
    os_strdup("RHSA-2020:0975", report->advisories[0]);
    report->advisories[1] = NULL;
    os_realloc(report->bugzilla_references, 2 * sizeof(char *), report->bugzilla_references);
    os_strdup("http://rhn.redhat.org/cgi-bin/bugreport.cgi?bug=925286", report->bugzilla_references[0]);
    report->bugzilla_references[1] = NULL;
    os_realloc(report->references, 2 * sizeof(char *), report->references);
    os_strdup("http://rhn.redhat.com/errata/RHSA-2016-2582.html", report->references[0]);
    report->references[1] = NULL;
    os_realloc(report->ref_sources, 2 * sizeof(char *), report->ref_sources);
    os_strdup("REDHAT", report->ref_sources[0]);
    report->ref_sources[1] = NULL;
    // Reported software
    os_strdup("libhogweed4", report->software);
    os_strdup("nettle", report->source);
    os_strdup("o:microsoft:windows_server_2008:r2:sp1::::::", report->generated_cpe);
    os_strdup("3.4-1", report->version);
    os_strdup("CVE-2016-6489 reports as vulnerable all the versions of this package", report->operation);
    os_strdup("4.3-2", report->operation_value);
    os_strdup("amd64", report->arch);
    // Agent data
    os_strdup("001", report->agent_id);
    os_strdup("Ubuntu_WAgent", report->agent_name);

    return OS_SUCCESS;
}

static int build_test_hash_node(OSHashNode* node, uint8_t feed) {
    if (!node)
        return OS_INVALID;

    os_strdup("CVE-2016-6489", node->key);

    cve_vuln_pkg* data = NULL;
    os_calloc(1, sizeof(cve_vuln_pkg), data);
    if (!data) {
        os_free(node->key);
        return OS_INVALID;
    }

    node->data = data;

    cve_vuln_pkg* next = NULL;
    os_calloc(1, sizeof(cve_vuln_pkg), next);
    if (!next) {
        os_free(node->key);
        wm_vuldet_free_cve_node(node->data);
        return OS_INVALID;
    }

    ((cve_vuln_pkg*)node->data)->next = next;
    data->discard = 1;

    w_strdup("libhogweed4", next->bin_name);
    w_strdup("5.3.4", next->version);
    next->feed |= feed;

    cve_vuln_cond_NVD* nvd_cond = NULL;
    os_calloc(1, sizeof(cve_vuln_cond_NVD), nvd_cond);
    if (!nvd_cond) {
        os_free(node->key);
        wm_vuldet_free_cve_node(node->data);
        return OS_INVALID;
    }

    next->nvd_cond = nvd_cond;

    cve_vuln_cond *vuln_cond = NULL;
    os_calloc(1, sizeof(cve_vuln_cond), vuln_cond);
    if (!vuln_cond) {
        os_free(node->key);
        wm_vuldet_free_cve_node(node->data);
        return OS_INVALID;
    }

    //vuln_cond->pending = 1; CHECK
    os_strdup("Pending confirmation", vuln_cond->state);
    os_strdup("CVE-2016-6489 reports as vulnerable all the versions of this package", vuln_cond->operation);
    os_strdup("4.3-2", vuln_cond->operation_value);
    os_strdup("Package less than 4.3-2", vuln_cond->condition);

    next->vuln_cond = vuln_cond;

    return OS_SUCCESS;
}

static int setup_agent_software(void **state) {
    agent_software *agent = calloc(1, sizeof(agent_software));

    if(!agent) {
        return OS_INVALID;
    }

    agent->agent_id = strdup("000");
    *state = agent;

    return OS_SUCCESS;
}

static int setup_cve_report(void **state) {
    wm_vuldet_t *vuldet = calloc(1, sizeof(wm_vuldet_t));

    if (!vuldet) {
        return OS_INVALID;
    }

    state[REPORT_CVE_VULDET_POS] = vuldet;
    vuldet->flags.enabled = 1;
    vuldet->flags.run_on_start = 1;

    will_return(__wrap_StartMQ, 1);
    will_return_always(__wrap_OPENSSL_init_ssl, 1);
    will_return(__wrap_OPENSSL_init_crypto, 1);

    wm_vuldet_init(vuldet);

    vu_report *report = calloc(1, sizeof(vu_report));

    if(!report) {
        os_free(vuldet);
        return OS_INVALID;
    }

    state[REPORT_CVE_REPORT_POS] = report;
    wm_max_eps = 1000000;

    return OS_SUCCESS;
}

static int setup_package_comparison(void **state) {
    cve_vuln_pkg *Pkg1 = NULL;
    os_calloc(1, sizeof(cve_vuln_pkg), Pkg1);

    cve_vuln_pkg *Pkg2 = NULL;
    os_calloc(1, sizeof(cve_vuln_pkg), Pkg2);

    cve_vuln_cond_NVD* nvd_cond1 = NULL;
    os_calloc(1, sizeof(cve_vuln_cond_NVD), nvd_cond1);

    cve_vuln_cond_NVD* nvd_cond2 = NULL;
    os_calloc(1, sizeof(cve_vuln_cond_NVD), nvd_cond2);

    cve_vuln_cond* vuln_cond1 = NULL;
    os_calloc(1, sizeof(cve_vuln_cond), vuln_cond1);

    cve_vuln_cond* vuln_cond2 = NULL;
    os_calloc(1, sizeof(cve_vuln_cond), vuln_cond2);

    if (!Pkg1 || !Pkg2 || !nvd_cond1 || !nvd_cond2 || !vuln_cond1 || !vuln_cond2) {
        os_free(vuln_cond1);
        os_free(vuln_cond2);
        os_free(nvd_cond1);
        os_free(nvd_cond2);
        os_free(Pkg1);
        os_free(Pkg2);
        return OS_INVALID;
    }

    Pkg1->vuln_cond = vuln_cond1;
    Pkg2->vuln_cond = vuln_cond2;

    Pkg1->nvd_cond = nvd_cond1;
    Pkg2->nvd_cond = nvd_cond2;

    state[PKG1_POS] = Pkg1;
    state[PKG2_POS] = Pkg2;

    return OS_SUCCESS;
}

static int teardown_agent_software(void **state) {
    agent_software *agent = *state;

    if(agent) {
        wm_vuldet_free_agent_software(agent);
    }

    return OS_SUCCESS;
}

static int teardown_cve_report(void **state) {
    wm_vuldet_t *vuldet = state[REPORT_CVE_VULDET_POS];
    vu_report *report = state[REPORT_CVE_REPORT_POS];

    if(vuldet) {
        os_free(vuldet);
    }

    if(report) {
        wm_vuldet_free_report(report);
    }

    return OS_SUCCESS;
}

static int teardown_package_comparison(void **state) {
    cve_vuln_pkg *Pkg1 = state[PKG1_POS];
    cve_vuln_pkg *Pkg2 = state[PKG2_POS];

    if (Pkg1) wm_vuldet_free_cve_node(Pkg1);
    if (Pkg2) wm_vuldet_free_cve_node(Pkg2);

    return OS_SUCCESS;
}

/* tests */

/* wm_vuldet_get_oslinux_info */

void test_wm_vuldet_get_oslinux_info(void **state)
{
    agent_software *agent = *state;

    const char *query = "agent 000 sql SELECT OS_MAJOR, OS_MINOR, RELEASE FROM SYS_OSINFO;";
    size_t query_size = strlen(query) + 1;

    char *response = "ok [{\"os_major\":\"10.0\",\"os_minor\":\"1\",\"release\":\"4.5.1\"}]";
    size_t response_size = strlen(response) + 1;

    expect_string(__wrap_OS_ConnectUnixDomain, path, WDB_LOCAL_SOCK_PATH);
    expect_value(__wrap_OS_ConnectUnixDomain, type, SOCK_STREAM);
    expect_value(__wrap_OS_ConnectUnixDomain, max_msg_size, OS_SIZE_6144);
    will_return(__wrap_OS_ConnectUnixDomain, 11111);

    expect_value(__wrap_OS_SendSecureTCP, sock, 11111);
    expect_value(__wrap_OS_SendSecureTCP, size, query_size);
    expect_string(__wrap_OS_SendSecureTCP, msg, query);
    will_return(__wrap_OS_SendSecureTCP, 0);

    expect_value(__wrap_OS_RecvSecureTCP, sock, 11111);
    expect_value(__wrap_OS_RecvSecureTCP, size, OS_SIZE_128);
    will_return(__wrap_OS_RecvSecureTCP, response);
    will_return(__wrap_OS_RecvSecureTCP, response_size);

    cJSON* parsed_json = __real_cJSON_CreateArray();
    cJSON* object = __real_cJSON_CreateObject();
    __real_cJSON_AddItemToArray(parsed_json, object);
    cJSON* os_major = __real_cJSON_CreateString("10.0");
    cJSON* os_minor = __real_cJSON_CreateString("1");
    cJSON* release = __real_cJSON_CreateString("4.5.1");
    __real_cJSON_AddItemToObject(object, "os_major", os_major);
    __real_cJSON_AddItemToObject(object, "os_minor", os_minor);
    __real_cJSON_AddItemToObject(object, "release", release);

    will_return(__wrap_cJSON_Parse, parsed_json);
    will_return(__wrap_cJSON_GetObjectItem, os_major);
    will_return(__wrap_cJSON_GetObjectItem, os_minor);
    will_return(__wrap_cJSON_GetObjectItem, release);

    expect_function_call(__wrap_cJSON_Delete);

    int ret = wm_vuldet_get_oslinux_info(agent);

    assert_int_equal(ret, 0);
    assert_string_equal(agent->os_release, "10.0.1");
    assert_string_equal(agent->kernel_release, "4.5.1");

    __real_cJSON_Delete(parsed_json);
}

void test_wm_vuldet_get_oslinux_info_only_major(void **state)
{
    agent_software *agent = *state;

    const char *query = "agent 000 sql SELECT OS_MAJOR, OS_MINOR, RELEASE FROM SYS_OSINFO;";
    size_t query_size = strlen(query) + 1;

    char *response = "ok [{\"os_major\":\"10.0 LTS\"}]";
    size_t response_size = strlen(response) + 1;

    expect_value(__wrap_OS_SendSecureTCP, sock, 11111);
    expect_value(__wrap_OS_SendSecureTCP, size, query_size);
    expect_string(__wrap_OS_SendSecureTCP, msg, query);
    will_return(__wrap_OS_SendSecureTCP, 0);

    expect_value(__wrap_OS_RecvSecureTCP, sock, 11111);
    expect_value(__wrap_OS_RecvSecureTCP, size, OS_SIZE_128);
    will_return(__wrap_OS_RecvSecureTCP, response);
    will_return(__wrap_OS_RecvSecureTCP, response_size);

    cJSON* parsed_json = __real_cJSON_CreateArray();
    cJSON* object = __real_cJSON_CreateObject();
    __real_cJSON_AddItemToArray(parsed_json, object);
    cJSON* os_major = __real_cJSON_CreateString("10.0");
    __real_cJSON_AddItemToObject(object, "os_major", os_major);

    will_return(__wrap_cJSON_Parse, parsed_json);
    will_return(__wrap_cJSON_GetObjectItem, os_major);
    will_return(__wrap_cJSON_GetObjectItem, NULL);
    will_return(__wrap_cJSON_GetObjectItem, NULL);

    expect_function_call(__wrap_cJSON_Delete);

    int ret = wm_vuldet_get_oslinux_info(agent);

    assert_int_equal(ret, 0);
    assert_string_equal(agent->os_release, "10.0.0");
    assert_null(agent->kernel_release);

    __real_cJSON_Delete(parsed_json);
}

void test_wm_vuldet_get_oslinux_info_only_release(void **state)
{
    agent_software *agent = *state;

    const char *query = "agent 000 sql SELECT OS_MAJOR, OS_MINOR, RELEASE FROM SYS_OSINFO;";
    size_t query_size = strlen(query) + 1;

    char *response = "ok [{\"release\":\"4.5.1\"}]";
    size_t response_size = strlen(response) + 1;

    expect_value(__wrap_OS_SendSecureTCP, sock, 11111);
    expect_value(__wrap_OS_SendSecureTCP, size, query_size);
    expect_string(__wrap_OS_SendSecureTCP, msg, query);
    will_return(__wrap_OS_SendSecureTCP, 0);

    expect_value(__wrap_OS_RecvSecureTCP, sock, 11111);
    expect_value(__wrap_OS_RecvSecureTCP, size, OS_SIZE_128);
    will_return(__wrap_OS_RecvSecureTCP, response);
    will_return(__wrap_OS_RecvSecureTCP, response_size);

    cJSON* parsed_json = __real_cJSON_CreateArray();
    cJSON* object = __real_cJSON_CreateObject();
    __real_cJSON_AddItemToArray(parsed_json, object);
    cJSON* release = __real_cJSON_CreateString("4.5.1");
    __real_cJSON_AddItemToObject(object, "release", release);

    will_return(__wrap_cJSON_Parse, parsed_json);
    will_return(__wrap_cJSON_GetObjectItem, NULL);
    will_return(__wrap_cJSON_GetObjectItem, release);

    expect_function_call(__wrap_cJSON_Delete);

    int ret = wm_vuldet_get_oslinux_info(agent);

    assert_int_equal(ret, 0);
    assert_null(agent->os_release);
    assert_string_equal(agent->kernel_release, "4.5.1");

    __real_cJSON_Delete(parsed_json);
}

void test_wm_vuldet_get_oslinux_info_null_agent(void **state)
{
    (void) state;

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5566): The agent structure is not initialized.");

    int ret = wm_vuldet_get_oslinux_info(NULL);

    assert_int_equal(ret, -1);
}

void test_wm_vuldet_get_oslinux_info_request_invalid(void **state)
{
    agent_software *agent = *state;

    const char *query = "agent 000 sql SELECT OS_MAJOR, OS_MINOR, RELEASE FROM SYS_OSINFO;";
    size_t query_size = strlen(query) + 1;

    expect_value(__wrap_OS_SendSecureTCP, sock, 11111);
    expect_value(__wrap_OS_SendSecureTCP, size, query_size);
    expect_string(__wrap_OS_SendSecureTCP, msg, query);
    will_return(__wrap_OS_SendSecureTCP, 0);

    expect_value(__wrap_OS_RecvSecureTCP, sock, 11111);
    expect_value(__wrap_OS_RecvSecureTCP, size, OS_SIZE_128);
    will_return(__wrap_OS_RecvSecureTCP, "");
    will_return(__wrap_OS_RecvSecureTCP, 0);

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5568): Couldn't get the OS information of the agent '000'");

    int ret = wm_vuldet_get_oslinux_info(agent);

    assert_int_equal(ret, -1);
    assert_null(agent->os_release);
    assert_null(agent->kernel_release);
}

void test_wm_vuldet_get_oslinux_info_request_error(void **state)
{
    agent_software *agent = *state;

    const char *query = "agent 000 sql SELECT OS_MAJOR, OS_MINOR, RELEASE FROM SYS_OSINFO;";
    size_t query_size = strlen(query) + 1;

    expect_string(__wrap_OS_ConnectUnixDomain, path, WDB_LOCAL_SOCK_PATH);
    expect_value(__wrap_OS_ConnectUnixDomain, type, SOCK_STREAM);
    expect_value(__wrap_OS_ConnectUnixDomain, max_msg_size, OS_SIZE_6144);
    will_return(__wrap_OS_ConnectUnixDomain, 11111);

    expect_value(__wrap_OS_SendSecureTCP, sock, 11111);
    expect_value(__wrap_OS_SendSecureTCP, size, query_size);
    expect_string(__wrap_OS_SendSecureTCP, msg, query);
    will_return(__wrap_OS_SendSecureTCP, 0);

    expect_value(__wrap_OS_RecvSecureTCP, sock, 11111);
    expect_value(__wrap_OS_RecvSecureTCP, size, OS_SIZE_128);
    will_return(__wrap_OS_RecvSecureTCP, "err");
    will_return(__wrap_OS_RecvSecureTCP, 3);

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5530): Invalid response from wazuh-db: 'err'");

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5568): Couldn't get the OS information of the agent '000'");

    int ret = wm_vuldet_get_oslinux_info(agent);

    assert_int_equal(ret, -1);
    assert_null(agent->os_release);
    assert_null(agent->kernel_release);
}

void test_wm_vuldet_get_oslinux_info_request_empty(void **state)
{
    agent_software *agent = *state;

    const char *query = "agent 000 sql SELECT OS_MAJOR, OS_MINOR, RELEASE FROM SYS_OSINFO;";
    size_t query_size = strlen(query) + 1;

    expect_value(__wrap_OS_SendSecureTCP, sock, 11111);
    expect_value(__wrap_OS_SendSecureTCP, size, query_size);
    expect_string(__wrap_OS_SendSecureTCP, msg, query);
    will_return(__wrap_OS_SendSecureTCP, 0);

    expect_value(__wrap_OS_RecvSecureTCP, sock, 11111);
    expect_value(__wrap_OS_RecvSecureTCP, size, OS_SIZE_128);
    will_return(__wrap_OS_RecvSecureTCP, "ok []");
    will_return(__wrap_OS_RecvSecureTCP, 5);

    int ret = wm_vuldet_get_oslinux_info(agent);

    assert_int_equal(ret, 0);
    assert_null(agent->os_release);
    assert_null(agent->kernel_release);
}

void test_wm_vuldet_get_oslinux_info_request_parse_error(void **state)
{
    agent_software *agent = *state;

    const char *query = "agent 000 sql SELECT OS_MAJOR, OS_MINOR, RELEASE FROM SYS_OSINFO;";
    size_t query_size = strlen(query) + 1;

    expect_value(__wrap_OS_SendSecureTCP, sock, 11111);
    expect_value(__wrap_OS_SendSecureTCP, size, query_size);
    expect_string(__wrap_OS_SendSecureTCP, msg, query);
    will_return(__wrap_OS_SendSecureTCP, 0);

    expect_value(__wrap_OS_RecvSecureTCP, sock, 11111);
    expect_value(__wrap_OS_RecvSecureTCP, size, OS_SIZE_128);
    will_return(__wrap_OS_RecvSecureTCP, "ok answer");
    will_return(__wrap_OS_RecvSecureTCP, 9);

    will_return(__wrap_cJSON_Parse, NULL);

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5568): Couldn't get the OS information of the agent '000'");

    int ret = wm_vuldet_get_oslinux_info(agent);

    assert_int_equal(ret, -1);
    assert_null(agent->os_release);
    assert_null(agent->kernel_release);
}

/* wm_vuldet_generate_os_and_kernel_package */

void test_wm_vuldet_generate_os_and_kernel_package_ubuntu(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;

    agent->dist = FEED_UBUNTU;
    agent->dist_ver = FEED_BIONIC;
    agent->os_release = strdup("18.04");
    agent->kernel_release = strdup("3.10");
    agent->arch = strdup("x86_64");

    will_return_count(__wrap_sqlite3_prepare_v2, SQLITE_OK, 2);
    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    will_return_count(__wrap_sqlite3_step, SQLITE_DONE, 2);

    // OS package
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "000");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_value(__wrap_sqlite3_bind_text, a, 3);
    expect_value(__wrap_sqlite3_bind_int, a, 4);
    expect_value(__wrap_sqlite3_bind_int, b, 0);
    expect_value(__wrap_sqlite3_bind_text, a, 5);
    expect_string(__wrap_sqlite3_bind_text, b, "canonical");
    expect_value(__wrap_sqlite3_bind_text, a, 6);
    expect_string(__wrap_sqlite3_bind_text, b, "ubuntu_linux");
    expect_value(__wrap_sqlite3_bind_text, a, 7);
    expect_value(__wrap_sqlite3_bind_text, a, 8);
    expect_string(__wrap_sqlite3_bind_text, b, "18.04");
    expect_value(__wrap_sqlite3_bind_text, a, 9);
    expect_value(__wrap_sqlite3_bind_text, a, 10);
    expect_string(__wrap_sqlite3_bind_text, b, "x86_64");

    // Kernel package
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "000");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_value(__wrap_sqlite3_bind_text, a, 3);
    expect_value(__wrap_sqlite3_bind_int, a, 4);
    expect_value(__wrap_sqlite3_bind_int, b, 0);
    expect_value(__wrap_sqlite3_bind_text, a, 5);
    expect_string(__wrap_sqlite3_bind_text, b, "linux");
    expect_value(__wrap_sqlite3_bind_text, a, 6);
    expect_string(__wrap_sqlite3_bind_text, b, "linux_kernel");
    expect_value(__wrap_sqlite3_bind_text, a, 7);
    expect_value(__wrap_sqlite3_bind_text, a, 8);
    expect_string(__wrap_sqlite3_bind_text, b, "3.10");
    expect_value(__wrap_sqlite3_bind_text, a, 9);
    expect_value(__wrap_sqlite3_bind_text, a, 10);
    expect_string(__wrap_sqlite3_bind_text, b, "x86_64");

    int ret = wm_vuldet_generate_os_and_kernel_package(db, agent);

    assert_int_equal(ret, 0);
}

void test_wm_vuldet_generate_os_and_kernel_package_debian(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;

    agent->dist = FEED_DEBIAN;
    agent->dist_ver = FEED_BUSTER;
    agent->os_release = strdup("10");
    agent->kernel_release = strdup("4.11");
    agent->arch = strdup("x86_64");

    will_return_count(__wrap_sqlite3_prepare_v2, SQLITE_OK, 2);
    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    will_return_count(__wrap_sqlite3_step, SQLITE_DONE, 2);

    // OS package
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "000");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_value(__wrap_sqlite3_bind_text, a, 3);
    expect_value(__wrap_sqlite3_bind_int, a, 4);
    expect_value(__wrap_sqlite3_bind_int, b, 0);
    expect_value(__wrap_sqlite3_bind_text, a, 5);
    expect_string(__wrap_sqlite3_bind_text, b, "debian");
    expect_value(__wrap_sqlite3_bind_text, a, 6);
    expect_string(__wrap_sqlite3_bind_text, b, "debian_linux");
    expect_value(__wrap_sqlite3_bind_text, a, 7);
    expect_value(__wrap_sqlite3_bind_text, a, 8);
    expect_string(__wrap_sqlite3_bind_text, b, "10");
    expect_value(__wrap_sqlite3_bind_text, a, 9);
    expect_value(__wrap_sqlite3_bind_text, a, 10);
    expect_string(__wrap_sqlite3_bind_text, b, "x86_64");

    // Kernel package
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "000");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_value(__wrap_sqlite3_bind_text, a, 3);
    expect_value(__wrap_sqlite3_bind_int, a, 4);
    expect_value(__wrap_sqlite3_bind_int, b, 0);
    expect_value(__wrap_sqlite3_bind_text, a, 5);
    expect_string(__wrap_sqlite3_bind_text, b, "linux");
    expect_value(__wrap_sqlite3_bind_text, a, 6);
    expect_string(__wrap_sqlite3_bind_text, b, "linux_kernel");
    expect_value(__wrap_sqlite3_bind_text, a, 7);
    expect_value(__wrap_sqlite3_bind_text, a, 8);
    expect_string(__wrap_sqlite3_bind_text, b, "4.11");
    expect_value(__wrap_sqlite3_bind_text, a, 9);
    expect_value(__wrap_sqlite3_bind_text, a, 10);
    expect_string(__wrap_sqlite3_bind_text, b, "x86_64");

    int ret = wm_vuldet_generate_os_and_kernel_package(db, agent);

    assert_int_equal(ret, 0);
}

void test_wm_vuldet_generate_os_and_kernel_package_redhat(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;

    agent->dist = FEED_REDHAT;
    agent->dist_ver = FEED_RHEL7;
    agent->os_release = strdup("7.2");
    agent->kernel_release = strdup("5.1.0");
    agent->arch = strdup("x86_64");

    will_return_count(__wrap_sqlite3_prepare_v2, SQLITE_OK, 2);
    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    will_return_count(__wrap_sqlite3_step, SQLITE_DONE, 2);

    // OS package
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "000");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_value(__wrap_sqlite3_bind_text, a, 3);
    expect_value(__wrap_sqlite3_bind_int, a, 4);
    expect_value(__wrap_sqlite3_bind_int, b, 0);
    expect_value(__wrap_sqlite3_bind_text, a, 5);
    expect_string(__wrap_sqlite3_bind_text, b, "redhat");
    expect_value(__wrap_sqlite3_bind_text, a, 6);
    expect_string(__wrap_sqlite3_bind_text, b, "enterprise_linux");
    expect_value(__wrap_sqlite3_bind_text, a, 7);
    expect_value(__wrap_sqlite3_bind_text, a, 8);
    expect_string(__wrap_sqlite3_bind_text, b, "7.2");
    expect_value(__wrap_sqlite3_bind_text, a, 9);
    expect_value(__wrap_sqlite3_bind_text, a, 10);
    expect_string(__wrap_sqlite3_bind_text, b, "x86_64");

    // Kernel package
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "000");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_value(__wrap_sqlite3_bind_text, a, 3);
    expect_value(__wrap_sqlite3_bind_int, a, 4);
    expect_value(__wrap_sqlite3_bind_int, b, 0);
    expect_value(__wrap_sqlite3_bind_text, a, 5);
    expect_string(__wrap_sqlite3_bind_text, b, "linux");
    expect_value(__wrap_sqlite3_bind_text, a, 6);
    expect_string(__wrap_sqlite3_bind_text, b, "linux_kernel");
    expect_value(__wrap_sqlite3_bind_text, a, 7);
    expect_value(__wrap_sqlite3_bind_text, a, 8);
    expect_string(__wrap_sqlite3_bind_text, b, "5.1.0");
    expect_value(__wrap_sqlite3_bind_text, a, 9);
    expect_value(__wrap_sqlite3_bind_text, a, 10);
    expect_string(__wrap_sqlite3_bind_text, b, "x86_64");

    int ret = wm_vuldet_generate_os_and_kernel_package(db, agent);

    assert_int_equal(ret, 0);
}

void test_wm_vuldet_generate_os_and_kernel_package_null_db(void **state)
{
    (void) state;

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5567): The DB is not initialized.");

    int ret = wm_vuldet_generate_os_and_kernel_package(NULL, NULL);

    assert_int_equal(ret, -1);
}

void test_wm_vuldet_generate_os_and_kernel_package_null_agent(void **state)
{
    (void) state;
    sqlite3 *db = (sqlite3 *)1;

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5566): The agent structure is not initialized.");

    int ret = wm_vuldet_generate_os_and_kernel_package(db, NULL);

    assert_int_equal(ret, -1);
}

void test_wm_vuldet_generate_os_and_kernel_package_invalid_agent(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;

    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5444): Unable to get the OS version and release for agent '000'. It may not have the OS inventory enabled. Skipping it.");

    int ret = wm_vuldet_generate_os_and_kernel_package(db, agent);

    assert_int_equal(ret, 1);
}

void test_wm_vuldet_generate_os_and_kernel_package_os_package_error(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;

    agent->dist = FEED_REDHAT;
    agent->dist_ver = FEED_RHEL7;
    agent->os_release = strdup("7.2");
    agent->arch = strdup("x86_64");

    // OS package
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);

    will_return(__wrap_sqlite3_errmsg, "error");

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5503): SQL error: 'error'");

    will_return(__wrap_sqlite3_close_v2, 0);

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5449): It was not possible to insert 'enterprise_linux' in the agent software table.");

    int ret = wm_vuldet_generate_os_and_kernel_package(db, agent);

    assert_int_equal(ret, -1);
}

void test_wm_vuldet_generate_os_and_kernel_package_kernel_package_error(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;

    agent->dist = FEED_REDHAT;
    agent->dist_ver = FEED_RHEL7;
    agent->kernel_release = strdup("5.1.0");
    agent->arch = strdup("x86_64");

    // Kernel package
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);

    will_return(__wrap_sqlite3_errmsg, "error");

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5503): SQL error: 'error'");

    will_return(__wrap_sqlite3_close_v2, 0);

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5449): It was not possible to insert 'linux_kernel' in the agent software table.");

    int ret = wm_vuldet_generate_os_and_kernel_package(db, agent);

    assert_int_equal(ret, -1);
}

/* wm_checks_package_vulnerability */

void test_wm_checks_package_vulnerability_no_version_b(void **state)
{
    char *version_a = "1:5.3.2-3.9.7";
    char *version_b = NULL;
    char *operation = "less than";

    int ret = wm_checks_package_vulnerability(version_a, operation, version_b, VER_TYPE_DEB);

    assert_int_equal(VU_NOT_FIXED, ret);
}

void test_wm_checks_package_vulnerability_big_version_a(void **state)
{
    char *version_a = NULL;
    char *version_b = "2:6.1.1-2.6.8";
    char *operation = "less than";

    // Creating a very big dummy string for version a
    os_calloc(KEY_SIZE + 10, sizeof(char), version_a);
    if (!version_a)
        return;

    for (int i = 0; i < (KEY_SIZE + 9); ++i) version_a[i] = 'a';

    int ret = wm_checks_package_vulnerability(version_a, operation, version_b, VER_TYPE_DEB);

    assert_int_equal(OS_INVALID, ret);

    os_free(version_a);
}

void test_wm_checks_package_vulnerability_big_version_b(void **state)
{
    char *version_a = "1:5.3.2-3.9.7";
    char *version_b = NULL;
    char *operation = "less than";

    // Creating a very big dummy string for version a
    os_calloc(KEY_SIZE + 10, sizeof(char), version_b);
    if (!version_b)
        return;

    for (int i = 0; i < (KEY_SIZE + 9); ++i) version_b[i] = 'b';

    int ret = wm_checks_package_vulnerability(version_a, operation, version_b, VER_TYPE_DEB);

    assert_int_equal(OS_INVALID, ret);

    os_free(version_b);
}

void test_wm_checks_package_vulnerability_lt_with_epoch(void **state)
{
    char *version_a = "1:5.3.2-3.9.7";
    char *version_b = "2:6.1.1-2.6.8";
    char *operation = "less than";

    expect_value(__wrap_pkg_version_relate, rel, PKG_RELATION_LT);
    will_return(__wrap_pkg_version_relate, true);

    int ret = wm_checks_package_vulnerability(version_a, operation, version_b, VER_TYPE_DEB);

    assert_int_equal(VU_VULNERABLE, ret);
}

void test_wm_checks_package_vulnerability_lt_no_epoch(void **state)
{
    char *version_a = "5.3.2-3.9.7";
    char *version_b = "6.1.1-2.6.8";
    char *operation = "less than";

    expect_value(__wrap_pkg_version_relate, rel, PKG_RELATION_LT);
    will_return(__wrap_pkg_version_relate, true);

    int ret = wm_checks_package_vulnerability(version_a, operation, version_b, VER_TYPE_DEB);

    assert_int_equal(VU_VULNERABLE, ret);
}

void test_wm_checks_package_vulnerability_lt_no_revision(void **state)
{
    char *version_a = "1:5.3.2";
    char *version_b = "2:6.1.1";
    char *operation = "less than";

    expect_value(__wrap_pkg_version_relate, rel, PKG_RELATION_LT);
    will_return(__wrap_pkg_version_relate, true);

    int ret = wm_checks_package_vulnerability(version_a, operation, version_b, VER_TYPE_DEB);

    assert_int_equal(VU_VULNERABLE, ret);
}

void test_wm_checks_package_vulnerability_lt_no_revision_and_score(void **state)
{
    char *version_a = "1:5.3.2-";
    char *version_b = "2:6.1.1-";
    char *operation = "less than";

    expect_value(__wrap_pkg_version_relate, rel, PKG_RELATION_LT);
    will_return(__wrap_pkg_version_relate, true);

    int ret = wm_checks_package_vulnerability(version_a, operation, version_b, VER_TYPE_DEB);

    assert_int_equal(VU_VULNERABLE, ret);
}

void test_wm_checks_package_vulnerability_le(void **state)
{
    char *version_a = "1:5.3.2-3.9.7";
    char *version_b = "2:6.1.1-2.6.8";
    char *operation = "less than or equal";

    expect_value(__wrap_pkg_version_relate, rel, PKG_RELATION_LE);
    will_return(__wrap_pkg_version_relate, true);

    int ret = wm_checks_package_vulnerability(version_a, operation, version_b, VER_TYPE_DEB);

    assert_int_equal(VU_VULNERABLE, ret);
}

void test_wm_checks_package_vulnerability_eq(void **state)
{
    char *version_a = "1:5.3.2-3.9.7";
    char *version_b = "2:6.1.1-2.6.8";
    char *operation = "equal";

    expect_value(__wrap_pkg_version_relate, rel, PKG_RELATION_EQ);
    will_return(__wrap_pkg_version_relate, false);

    int ret = wm_checks_package_vulnerability(version_a, operation, version_b, VER_TYPE_DEB);

    assert_int_equal(VU_NOT_VULNERABLE, ret);
}

void test_wm_checks_package_vulnerability_ge(void **state)
{
    char *version_a = "1:5.3.2-3.9.7";
    char *version_b = "2:6.1.1-2.6.8";
    char *operation = "greater than or equal";

    expect_value(__wrap_pkg_version_relate, rel, PKG_RELATION_GE);
    will_return(__wrap_pkg_version_relate, false);

    int ret = wm_checks_package_vulnerability(version_a, operation, version_b, VER_TYPE_DEB);

    assert_int_equal(VU_NOT_VULNERABLE, ret);
}

void test_wm_checks_package_vulnerability_gt(void **state)
{
    char *version_a = "1:5.3.2-3.9.7";
    char *version_b = "2:6.1.1-2.6.8";
    char *operation = "greater than";

    expect_value(__wrap_pkg_version_relate, rel, PKG_RELATION_GT);
    will_return(__wrap_pkg_version_relate, false);

    int ret = wm_checks_package_vulnerability(version_a, operation, version_b, VER_TYPE_DEB);

    assert_int_equal(VU_NOT_VULNERABLE, ret);
}

void test_wm_checks_package_vulnerability_ne(void **state)
{
    char *version_a = "1:5.3.2-3.9.7";
    char *version_b = "2:6.1.1-2.6.8";
    char *operation = "not equal";

    int ret = wm_checks_package_vulnerability(version_a, operation, version_b, VER_TYPE_DEB);

    assert_int_equal(VU_ERROR_CMP, ret);
}

/* wm_vuldet_linux_oval_vulnerabilities */

void test_wm_vuldet_linux_oval_vulnerabilities_error_prepare(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5456): Analyzing OVAL vulnerabilities for agent '000'");

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5569): Couldn't get the packages of the agent '000'");

    will_return(__wrap_sqlite3_errmsg, "error");

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5503): SQL error: 'error'");

    will_return(__wrap_sqlite3_close_v2, SQLITE_OK);

    int ret = wm_vuldet_linux_oval_vulnerabilities(db, agent, cve_table);

    assert_int_equal(OS_INVALID, ret);
}

void test_wm_vuldet_linux_oval_vulnerabilities_error_prepare_rh(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    agent->dist = FEED_REDHAT;

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5456): Analyzing OVAL vulnerabilities for agent '000'");

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5569): Couldn't get the packages of the agent '000'");

    will_return(__wrap_sqlite3_errmsg, "error");

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5503): SQL error: 'error'");

    will_return(__wrap_sqlite3_close_v2, SQLITE_OK);

    int ret = wm_vuldet_linux_oval_vulnerabilities(db, agent, cve_table);

    assert_int_equal(OS_INVALID, ret);
}

void test_wm_vuldet_linux_oval_vulnerabilities_error_prepare_deb(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    agent->dist = FEED_DEBIAN;

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5456): Analyzing OVAL vulnerabilities for agent '000'");

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5569): Couldn't get the packages of the agent '000'");

    will_return(__wrap_sqlite3_errmsg, "error");

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5503): SQL error: 'error'");

    will_return(__wrap_sqlite3_close_v2, SQLITE_OK);

    int ret = wm_vuldet_linux_oval_vulnerabilities(db, agent, cve_table);

    assert_int_equal(OS_INVALID, ret);
}

void test_wm_vuldet_linux_oval_vulnerabilities_error_step(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    agent->dist = FEED_DEBIAN;
    agent->dist_ver = FEED_JESSIE;

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5456): Analyzing OVAL vulnerabilities for agent '000'");

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);

    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    // building query
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "JESSIE");
    expect_value(__wrap_sqlite3_bind_int, a, 2);
    expect_value(__wrap_sqlite3_bind_int, b, 0);

    will_return(__wrap_sqlite3_step, SQLITE_ERROR);

    will_return(__wrap_sqlite3_errmsg, "error");

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5503): SQL error: 'error'");

    will_return(__wrap_sqlite3_close_v2, SQLITE_OK);

    int ret = wm_vuldet_linux_oval_vulnerabilities(db, agent, cve_table);

    assert_int_equal(OS_INVALID, ret);
}

void test_wm_vuldet_linux_oval_vulnerabilities_step_done(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    agent->dist = FEED_DEBIAN;
    agent->dist_ver = FEED_JESSIE;

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5456): Analyzing OVAL vulnerabilities for agent '000'");

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);

    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    // building query
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "JESSIE");
    expect_value(__wrap_sqlite3_bind_int, a, 2);
    expect_value(__wrap_sqlite3_bind_int, b, 0);

    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    expect_string(__wrap__mtwarn, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtwarn, formatted_msg, "(5575): Unavailable vulnerability data for the agent '000' OS. Skipping it.");

    int ret = wm_vuldet_linux_oval_vulnerabilities(db, agent, cve_table);

    assert_int_equal(0, ret);
}

void test_wm_vuldet_linux_oval_vulnerabilities_one_row_no_data(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    agent->dist = FEED_DEBIAN;
    agent->dist_ver = FEED_JESSIE;

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5456): Analyzing OVAL vulnerabilities for agent '000'");

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);

    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    // building query
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "JESSIE");
    expect_value(__wrap_sqlite3_bind_int, a, 2);
    expect_value(__wrap_sqlite3_bind_int, b, 0);

    will_return(__wrap_sqlite3_step, SQLITE_ROW);

    // By assigning null to some values, the row should be skipped
    // and the code should ask for a new row
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "source");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "less than");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, "5.4.3");
    expect_value(__wrap_sqlite3_column_text, i, 7);
    will_return(__wrap_sqlite3_column_text, "10");

    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5457): The OVAL found a total of '0' potential vulnerabilities for agent '000'");
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5470): It took '0' seconds to 'find OVAL' vulnerabilities in agent '000'");

    int ret = wm_vuldet_linux_oval_vulnerabilities(db, agent, cve_table);

    assert_int_equal(OS_SUCCESS, ret);
}

void test_wm_vuldet_linux_oval_vulnerabilities_one_row_bad_version(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    agent->dist = FEED_DEBIAN;
    agent->dist_ver = FEED_JESSIE;

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5456): Analyzing OVAL vulnerabilities for agent '000'");

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);

    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    // building query
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "JESSIE");
    expect_value(__wrap_sqlite3_bind_int, a, 2);
    expect_value(__wrap_sqlite3_bind_int, b, 0);

    will_return(__wrap_sqlite3_step, SQLITE_ROW);

    // Creating a very big dummy string for version a
    char *version_b = NULL;
    os_calloc(KEY_SIZE + 10, sizeof(char), version_b);
    if (!version_b)
        return;

    for (int i = 0; i < (KEY_SIZE + 9); ++i) version_b[i] = 'b';

    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "CVE-2020-1234");
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, "package");
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "source");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, "5.1.2");
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "x64");
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "less than");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, version_b);
    expect_value(__wrap_sqlite3_column_text, i, 7);
    will_return(__wrap_sqlite3_column_text, "10");

    int ret = wm_vuldet_linux_oval_vulnerabilities(db, agent, cve_table);

    assert_int_equal(OS_INVALID, ret);

    os_free(version_b);
}

void test_wm_vuldet_linux_oval_vulnerabilities_one_row_not_fixed(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    agent->dist = FEED_DEBIAN;
    agent->dist_ver = FEED_JESSIE;

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5456): Analyzing OVAL vulnerabilities for agent '000'");

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);

    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    // building query
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "JESSIE");
    expect_value(__wrap_sqlite3_bind_int, a, 2);
    expect_value(__wrap_sqlite3_bind_int, b, 0);

    will_return(__wrap_sqlite3_step, SQLITE_ROW);

    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "CVE-2020-1234");
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, "package");
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "source");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, "5.1.2");
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "x64");
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 7);
    will_return(__wrap_sqlite3_column_text, NULL);

    // Adding cve node
    cve_vuln_pkg *Pkg = NULL;
    os_calloc(1, sizeof(cve_vuln_pkg), Pkg);
    if (!Pkg)
        return;

    os_strdup("src_name1", Pkg->src_name);

    expect_string(__wrap_OSHash_Add, key, "CVE-2020-1234");
    will_return(__wrap_OSHash_Add, 1);
    expect_string(__wrap_OSHash_Get, key, "CVE-2020-1234");
    will_return(__wrap_OSHash_Get, Pkg);

    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5458): Package 'package' inserted into the vulnerability 'CVE-2020-1234'. Version (5.1.2) 'Unfixed' '' (feed 'OVAL').");

    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5457): The OVAL found a total of '1' potential vulnerabilities for agent '000'");
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5470): It took '0' seconds to 'find OVAL' vulnerabilities in agent '000'");

    int ret = wm_vuldet_linux_oval_vulnerabilities(db, agent, cve_table);

    assert_int_equal(OS_SUCCESS, ret);

    wm_vuldet_free_cve_node(Pkg);
}

void test_wm_vuldet_linux_oval_vulnerabilities_one_row_not_vulnerable(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    agent->dist = FEED_DEBIAN;
    agent->dist_ver = FEED_JESSIE;

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5456): Analyzing OVAL vulnerabilities for agent '000'");

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);

    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    // building query
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "JESSIE");
    expect_value(__wrap_sqlite3_bind_int, a, 2);
    expect_value(__wrap_sqlite3_bind_int, b, 0);

    will_return(__wrap_sqlite3_step, SQLITE_ROW);

    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "CVE-2020-1234");
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, "package");
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "source");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, "5.1.2");
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "x64");
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "less than");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, "5.1.1");
    expect_value(__wrap_sqlite3_column_text, i, 7);
    will_return(__wrap_sqlite3_column_text, "10");

    // Adding cve node
    cve_vuln_pkg *Pkg = NULL;
    os_calloc(1, sizeof(cve_vuln_pkg), Pkg);
    if (!Pkg)
        return;

    os_strdup("src_name1", Pkg->src_name);

    expect_value(__wrap_pkg_version_relate, rel, PKG_RELATION_LT);
    will_return(__wrap_pkg_version_relate, 0);

    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5460): Package 'package' not vulnerable to 'CVE-2020-1234'. Version (10) not 'less than' '5.1.1' (feed 'OVAL').");

    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5457): The OVAL found a total of '0' potential vulnerabilities for agent '000'");
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5470): It took '0' seconds to 'find OVAL' vulnerabilities in agent '000'");

    int ret = wm_vuldet_linux_oval_vulnerabilities(db, agent, cve_table);

    assert_int_equal(OS_SUCCESS, ret);

    wm_vuldet_free_cve_node(Pkg);
}

void test_wm_vuldet_linux_oval_vulnerabilities_one_row_error_comparing(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    agent->dist = FEED_DEBIAN;
    agent->dist_ver = FEED_JESSIE;

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5456): Analyzing OVAL vulnerabilities for agent '000'");

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);

    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    // building query
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "JESSIE");
    expect_value(__wrap_sqlite3_bind_int, a, 2);
    expect_value(__wrap_sqlite3_bind_int, b, 0);

    will_return(__wrap_sqlite3_step, SQLITE_ROW);

    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "CVE-2020-1234");
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, "package");
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "source");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, "5.1.2");
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "x64");
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "unexisting relation");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, "5.1.1");
    expect_value(__wrap_sqlite3_column_text, i, 7);
    will_return(__wrap_sqlite3_column_text, "10");

    // Adding cve node
    cve_vuln_pkg *Pkg2 = NULL;
    os_calloc(1, sizeof(cve_vuln_pkg), Pkg2);
    if (!Pkg2)
        return;

    os_strdup("src_name2", Pkg2->src_name);
    os_strdup("package2", Pkg2->bin_name);
    os_strdup("5.1.2", Pkg2->version);
    os_strdup("x64", Pkg2->arch);

    expect_string(__wrap_OSHash_Add, key, "CVE-2020-1234");
    will_return(__wrap_OSHash_Add, 1);
    expect_string(__wrap_OSHash_Get, key, "CVE-2020-1234");
    will_return(__wrap_OSHash_Get, Pkg2);

    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5458): Package 'package' inserted into the vulnerability 'CVE-2020-1234'. Version (10) 'unexisting relation' '5.1.1' (feed 'OVAL').");

    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5457): The OVAL found a total of '1' potential vulnerabilities for agent '000'");
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5470): It took '0' seconds to 'find OVAL' vulnerabilities in agent '000'");

    int ret = wm_vuldet_linux_oval_vulnerabilities(db, agent, cve_table);

    assert_int_equal(OS_SUCCESS, ret);

    wm_vuldet_free_cve_node(Pkg2);
}

/* wm_vuldet_build_nvd_report_condition */

void test_wm_vuldet_build_nvd_report_condition_both_including(void **state)
{
    cve_vuln_cond_NVD *nvd_cond = NULL;
    os_calloc(1, sizeof(cve_vuln_cond_NVD), nvd_cond);
    if (!nvd_cond)
        return;

    vu_report * report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    os_strdup("10.5.0", nvd_cond->start_version);
    nvd_cond->start_operation = START_INCLUDED;
    os_strdup("10.7.1", nvd_cond->end_version);
    nvd_cond->end_operation = END_INCLUDED;

    wm_vuldet_build_nvd_report_condition(nvd_cond, report);

    assert_string_equal("Package greater or equal than 10.5.0 and less or equal than 10.7.1", report->condition);

    os_free(nvd_cond->start_version);
    os_free(nvd_cond->end_version);
    os_free(nvd_cond);
    wm_vuldet_free_report(report);
}

void test_wm_vuldet_build_nvd_report_condition_both_excluding(void **state) {
    cve_vuln_cond_NVD *nvd_cond = NULL;
    os_calloc(1, sizeof(cve_vuln_cond_NVD), nvd_cond);
    if (!nvd_cond)
        return;

    vu_report * report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    os_strdup("10.5.0", nvd_cond->start_version);
    nvd_cond->start_operation = START_EXCLUDED;
    os_strdup("10.7.1", nvd_cond->end_version);
    nvd_cond->end_operation = END_EXCLUDED;

    wm_vuldet_build_nvd_report_condition(nvd_cond, report);

    assert_string_equal("Package greater than 10.5.0 and less than 10.7.1", report->condition);

    os_free(nvd_cond->start_version);
    os_free(nvd_cond->end_version);
    os_free(nvd_cond);
    wm_vuldet_free_report(report);
}

void test_wm_vuldet_build_nvd_report_condition_start_including(void **state) {
    cve_vuln_cond_NVD *nvd_cond = NULL;
    os_calloc(1, sizeof(cve_vuln_cond_NVD), nvd_cond);
    if (!nvd_cond)
        return;

    vu_report * report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    os_strdup("10.5.0", nvd_cond->start_version);
    nvd_cond->start_operation = START_INCLUDED;

    wm_vuldet_build_nvd_report_condition(nvd_cond, report);

    assert_string_equal("Package greater or equal than 10.5.0", report->condition);

    os_free(nvd_cond->start_version);
    os_free(nvd_cond->end_version);
    os_free(nvd_cond);
    wm_vuldet_free_report(report);
}

void test_wm_vuldet_build_nvd_report_condition_start_excluding(void **state) {
    cve_vuln_cond_NVD *nvd_cond = NULL;
    os_calloc(1, sizeof(cve_vuln_cond_NVD), nvd_cond);
    if (!nvd_cond)
        return;

    vu_report * report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    os_strdup("10.5.0", nvd_cond->start_version);
    nvd_cond->start_operation = START_EXCLUDED;

    wm_vuldet_build_nvd_report_condition(nvd_cond, report);

    assert_string_equal("Package greater than 10.5.0", report->condition);

    os_free(nvd_cond->start_version);
    os_free(nvd_cond->end_version);
    os_free(nvd_cond);
    wm_vuldet_free_report(report);
}

void test_wm_vuldet_build_nvd_report_condition_end_including(void **state) {
    cve_vuln_cond_NVD *nvd_cond = NULL;
    os_calloc(1, sizeof(cve_vuln_cond_NVD), nvd_cond);
    if (!nvd_cond)
        return;

    vu_report * report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    os_strdup("10.7.1", nvd_cond->end_version);
    nvd_cond->end_operation = END_INCLUDED;

    wm_vuldet_build_nvd_report_condition(nvd_cond, report);

    assert_string_equal("Package less or equal than 10.7.1", report->condition);

    os_free(nvd_cond->start_version);
    os_free(nvd_cond->end_version);
    os_free(nvd_cond);
    wm_vuldet_free_report(report);
}

void test_wm_vuldet_build_nvd_report_condition_end_excluding(void **state) {
    cve_vuln_cond_NVD *nvd_cond = NULL;
    os_calloc(1, sizeof(cve_vuln_cond_NVD), nvd_cond);
    if (!nvd_cond)
        return;

    vu_report * report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    os_strdup("10.7.1", nvd_cond->end_version);
    nvd_cond->end_operation = END_EXCLUDED;

    wm_vuldet_build_nvd_report_condition(nvd_cond, report);

    assert_string_equal("Package less than 10.7.1", report->condition);

    os_free(nvd_cond->start_version);
    os_free(nvd_cond->end_version);
    os_free(nvd_cond);
    wm_vuldet_free_report(report);
}

/* wm_vuldet_fill_report_nvd_cve_info */

void test_wm_vuldet_fill_report_nvd_cve_info_error_prepare(void **state) {
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    vu_report* report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    int cve_table_id = 1; // Just a dummy ID

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);

    int ret = wm_vuldet_fill_report_nvd_cve_info(db, stmt, report, &cve_table_id);

    assert_int_equal(SQLITE_ERROR, ret);

    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_nvd_cve_info_error_step(void **state) {
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    vu_report* report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    os_strdup("CVE-2016-6489", report->cve);
    int cve_table_id = 1; // Just a dummy ID

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    will_return(__wrap_sqlite3_bind_text, SQLITE_OK);
    will_return(__wrap_sqlite3_step, SQLITE_ERROR);

    int ret = wm_vuldet_fill_report_nvd_cve_info(db, stmt, report, &cve_table_id);

    assert_int_equal(SQLITE_ERROR, ret);

    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_nvd_cve_info_ok(void **state) {
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    vu_report* report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    os_strdup("CVE-2016-6489", report->cve);
    int cve_table_id = 1; // Just a dummy ID

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    will_return(__wrap_sqlite3_bind_text, SQLITE_OK);
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "1");
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, "CWE-502");
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "cve@mitre.org");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, "The CVE description or rationale.");
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "4.0");
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "2017-04-14");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, "2017-07-01");

    int ret = wm_vuldet_fill_report_nvd_cve_info(db, stmt, report, &cve_table_id);

    assert_int_equal(SQLITE_OK, ret);

    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_nvd_references_error_prepare(void **state) {
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    vu_report* report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    int cve_table_id = 1; // Just a dummy ID

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);

    int ret = wm_vuldet_fill_report_nvd_references(db, stmt, cve_table_id, report);

    assert_int_equal(SQLITE_ERROR, ret);

    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_nvd_references_error_step(void **state) {
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    vu_report* report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    int cve_table_id = 1; // Just a dummy ID

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_int, a, 1);
    expect_value(__wrap_sqlite3_bind_int, b, cve_table_id);
    will_return(__wrap_sqlite3_bind_int, SQLITE_OK);
    will_return(__wrap_sqlite3_step, SQLITE_ERROR);

    int ret = wm_vuldet_fill_report_nvd_references(db, stmt, cve_table_id, report);

    assert_int_equal(SQLITE_ERROR, ret);

    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_nvd_references_ok(void **state) {
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    vu_report* report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    int cve_table_id = 1; // Just a dummy ID

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_int, a, 1);
    expect_value(__wrap_sqlite3_bind_int, b, cve_table_id);
    will_return(__wrap_sqlite3_bind_int, SQLITE_OK);
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "http://rhn.redhat.com/errata/RHSA-2016-2582.html");
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, "REDHAT");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    int ret = wm_vuldet_fill_report_nvd_references(db, stmt, cve_table_id, report);

    assert_int_equal(SQLITE_OK, ret);

    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_nvd_scoring_error_prepare(void **state) {
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    vu_report* report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    int cve_table_id = 1; // Just a dummy ID

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);

    int ret = wm_vuldet_fill_report_nvd_scoring(db, stmt, cve_table_id, report);

    assert_int_equal(SQLITE_ERROR, ret);

    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_nvd_scoring_error_step(void **state) {
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    vu_report* report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    int cve_table_id = 1; // Just a dummy ID

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_int, a, 1);
    expect_value(__wrap_sqlite3_bind_int, b, cve_table_id);
    will_return(__wrap_sqlite3_bind_int, SQLITE_OK);
    will_return(__wrap_sqlite3_step, SQLITE_ERROR);

    int ret = wm_vuldet_fill_report_nvd_scoring(db, stmt, cve_table_id, report);

    assert_int_equal(SQLITE_ERROR, ret);

    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_nvd_scoring_cvss3_sev_crucial(void **state) {
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    vu_report* report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    int cve_table_id = 1; // Just a dummy ID

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_int, a, 1);
    expect_value(__wrap_sqlite3_bind_int, b, cve_table_id);
    will_return(__wrap_sqlite3_bind_int, SQLITE_OK);
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "AV:N/AC:M/Au:N/C:N/I:N/A:C");
    expect_value(__wrap_sqlite3_column_double, i, 1);
    will_return(__wrap_sqlite3_column_double, 9.1);
    expect_value(__wrap_sqlite3_column_double, i, 2);
    will_return(__wrap_sqlite3_column_double, 8.6);
    expect_value(__wrap_sqlite3_column_double, i, 3);
    will_return(__wrap_sqlite3_column_double, 6.9);
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "3.0");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    int ret = wm_vuldet_fill_report_nvd_scoring(db, stmt, cve_table_id, report);

    assert_int_equal(SQLITE_OK, ret);

    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_nvd_scoring_cvss3_sev_high(void **state) {
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    vu_report* report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    int cve_table_id = 1; // Just a dummy ID

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_int, a, 1);
    expect_value(__wrap_sqlite3_bind_int, b, cve_table_id);
    will_return(__wrap_sqlite3_bind_int, SQLITE_OK);
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "AV:N/AC:M/Au:N/C:N/I:N/A:C");
    expect_value(__wrap_sqlite3_column_double, i, 1);
    will_return(__wrap_sqlite3_column_double, 7.1);
    expect_value(__wrap_sqlite3_column_double, i, 2);
    will_return(__wrap_sqlite3_column_double, 8.6);
    expect_value(__wrap_sqlite3_column_double, i, 3);
    will_return(__wrap_sqlite3_column_double, 6.9);
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "3.0");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    int ret = wm_vuldet_fill_report_nvd_scoring(db, stmt, cve_table_id, report);

    assert_int_equal(SQLITE_OK, ret);

    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_nvd_scoring_cvss3_sev_medium(void **state) {
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    vu_report* report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    int cve_table_id = 1; // Just a dummy ID

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_int, a, 1);
    expect_value(__wrap_sqlite3_bind_int, b, cve_table_id);
    will_return(__wrap_sqlite3_bind_int, SQLITE_OK);
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "AV:N/AC:M/Au:N/C:N/I:N/A:C");
    expect_value(__wrap_sqlite3_column_double, i, 1);
    will_return(__wrap_sqlite3_column_double, 4.1);
    expect_value(__wrap_sqlite3_column_double, i, 2);
    will_return(__wrap_sqlite3_column_double, 8.6);
    expect_value(__wrap_sqlite3_column_double, i, 3);
    will_return(__wrap_sqlite3_column_double, 6.9);
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "3.0");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    int ret = wm_vuldet_fill_report_nvd_scoring(db, stmt, cve_table_id, report);

    assert_int_equal(SQLITE_OK, ret);

    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_nvd_scoring_cvss3_sev_low(void **state) {
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    vu_report* report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    int cve_table_id = 1; // Just a dummy ID

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_int, a, 1);
    expect_value(__wrap_sqlite3_bind_int, b, cve_table_id);
    will_return(__wrap_sqlite3_bind_int, SQLITE_OK);
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "AV:N/AC:M/Au:N/C:N/I:N/A:C");
    expect_value(__wrap_sqlite3_column_double, i, 1);
    will_return(__wrap_sqlite3_column_double, 1.1);
    expect_value(__wrap_sqlite3_column_double, i, 2);
    will_return(__wrap_sqlite3_column_double, 8.6);
    expect_value(__wrap_sqlite3_column_double, i, 3);
    will_return(__wrap_sqlite3_column_double, 6.9);
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "3.0");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    int ret = wm_vuldet_fill_report_nvd_scoring(db, stmt, cve_table_id, report);

    assert_int_equal(SQLITE_OK, ret);

    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_nvd_scoring_cvss3_sev_none(void **state) {
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    vu_report* report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    int cve_table_id = 1; // Just a dummy ID

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_int, a, 1);
    expect_value(__wrap_sqlite3_bind_int, b, cve_table_id);
    will_return(__wrap_sqlite3_bind_int, SQLITE_OK);
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "AV:N/AC:M/Au:N/C:N/I:N/A:C");
    expect_value(__wrap_sqlite3_column_double, i, 1);
    will_return(__wrap_sqlite3_column_double, 0.1);
    expect_value(__wrap_sqlite3_column_double, i, 2);
    will_return(__wrap_sqlite3_column_double, 8.6);
    expect_value(__wrap_sqlite3_column_double, i, 3);
    will_return(__wrap_sqlite3_column_double, 6.9);
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "3.0");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    int ret = wm_vuldet_fill_report_nvd_scoring(db, stmt, cve_table_id, report);

    assert_int_equal(SQLITE_OK, ret);

    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_nvd_scoring_cvss2_sev_high(void **state) {
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    vu_report* report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    int cve_table_id = 1; // Just a dummy ID

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_int, a, 1);
    expect_value(__wrap_sqlite3_bind_int, b, cve_table_id);
    will_return(__wrap_sqlite3_bind_int, SQLITE_OK);
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "AV:N/AC:M/Au:N/C:N/I:N/A:C");
    expect_value(__wrap_sqlite3_column_double, i, 1);
    will_return(__wrap_sqlite3_column_double, 7.1);
    expect_value(__wrap_sqlite3_column_double, i, 2);
    will_return(__wrap_sqlite3_column_double, 8.6);
    expect_value(__wrap_sqlite3_column_double, i, 3);
    will_return(__wrap_sqlite3_column_double, 6.9);
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "2.0");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    int ret = wm_vuldet_fill_report_nvd_scoring(db, stmt, cve_table_id, report);

    assert_int_equal(SQLITE_OK, ret);

    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_nvd_scoring_cvss2_sev_medium(void **state) {
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    vu_report* report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    int cve_table_id = 1; // Just a dummy ID

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_int, a, 1);
    expect_value(__wrap_sqlite3_bind_int, b, cve_table_id);
    will_return(__wrap_sqlite3_bind_int, SQLITE_OK);
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "AV:N/AC:M/Au:N/C:N/I:N/A:C");
    expect_value(__wrap_sqlite3_column_double, i, 1);
    will_return(__wrap_sqlite3_column_double, 4.1);
    expect_value(__wrap_sqlite3_column_double, i, 2);
    will_return(__wrap_sqlite3_column_double, 8.6);
    expect_value(__wrap_sqlite3_column_double, i, 3);
    will_return(__wrap_sqlite3_column_double, 6.9);
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "2.0");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    int ret = wm_vuldet_fill_report_nvd_scoring(db, stmt, cve_table_id, report);

    assert_int_equal(SQLITE_OK, ret);

    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_nvd_scoring_cvss2_sev_low(void **state) {
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    vu_report* report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    int cve_table_id = 1; // Just a dummy ID

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_int, a, 1);
    expect_value(__wrap_sqlite3_bind_int, b, cve_table_id);
    will_return(__wrap_sqlite3_bind_int, SQLITE_OK);
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "AV:N/AC:M/Au:N/C:N/I:N/A:C");
    expect_value(__wrap_sqlite3_column_double, i, 1);
    will_return(__wrap_sqlite3_column_double, 1.1);
    expect_value(__wrap_sqlite3_column_double, i, 2);
    will_return(__wrap_sqlite3_column_double, 8.6);
    expect_value(__wrap_sqlite3_column_double, i, 3);
    will_return(__wrap_sqlite3_column_double, 6.9);
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "2.0");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    int ret = wm_vuldet_fill_report_nvd_scoring(db, stmt, cve_table_id, report);

    assert_int_equal(SQLITE_OK, ret);

    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_nvd_scoring_sev_unknown(void **state) {
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    vu_report* report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if (!report)
        return;

    int cve_table_id = 1; // Just a dummy ID

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_int, a, 1);
    expect_value(__wrap_sqlite3_bind_int, b, cve_table_id);
    will_return(__wrap_sqlite3_bind_int, SQLITE_OK);
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "");
    expect_value(__wrap_sqlite3_column_double, i, 1);
    will_return(__wrap_sqlite3_column_double, 0);
    expect_value(__wrap_sqlite3_column_double, i, 2);
    will_return(__wrap_sqlite3_column_double, 0);
    expect_value(__wrap_sqlite3_column_double, i, 3);
    will_return(__wrap_sqlite3_column_double, 0);
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, NULL);
    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    int ret = wm_vuldet_fill_report_nvd_scoring(db, stmt, cve_table_id, report);

    assert_int_equal(SQLITE_OK, ret);

    wm_vuldet_free_report(report);
}

/* wm_vuldet_fill_report_oval_data */

void test_wm_vuldet_fill_report_oval_data_prepare_error(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    agent->dist = FEED_REDHAT;

    OSHashNode* node = NULL;
    os_calloc(1, sizeof(OSHashNode), node);
    if (!node || (OS_INVALID == build_test_hash_node(node, VU_SRC_NVD)))
        return;

    vu_report *report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if(!report)
        return;

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);

    int ret = wm_vuldet_fill_report_oval_data(db, stmt, agent, ((cve_vuln_pkg*)node->data)->next, report);

    assert_int_equal(ret, SQLITE_ERROR);

    wm_vuldet_free_cve_node(node->data);
    os_free(node->key);
    os_free(node);
    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_oval_data_references_error(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    agent->dist = FEED_UBUNTU;
    agent->dist_ver = FEED_FOCAL;

    OSHashNode* node = NULL;
    os_calloc(1, sizeof(OSHashNode), node);
    if (!node || (OS_INVALID == build_test_hash_node(node, VU_SRC_NVD)))
        return;

    vu_report *report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if(!report)
        return;

    os_strdup("CVE-2016-6489", report->cve);

    will_return_always(__wrap_sqlite3_bind_text, 0);
    // vulnerability info query
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "The CVE title.");
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, vu_severities[VU_HIGH]);
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "2017-04-14");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, "2017-07-01");
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "The CVE description or rationale.");
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "6.9");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, "3.6");
    expect_value(__wrap_sqlite3_column_text, i, 7);
    will_return(__wrap_sqlite3_column_text, "AV:N/AC:M/Au:N/C:N/I:N/A:C");
    expect_value(__wrap_sqlite3_column_text, i, 8);
    will_return(__wrap_sqlite3_column_text, "CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H");
    expect_value(__wrap_sqlite3_column_text, i, 9);
    will_return(__wrap_sqlite3_column_text, "CWE-502");
    //Query for references error
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);

    int ret = wm_vuldet_fill_report_oval_data(db, stmt, agent, ((cve_vuln_pkg*)node->data)->next, report);

    assert_int_equal(ret, SQLITE_ERROR);

    wm_vuldet_free_cve_node(node->data);
    os_free(node->key);
    os_free(node);
    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_oval_data_bugzilla_references_error(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    agent->dist = FEED_UBUNTU;
    agent->dist_ver = FEED_FOCAL;

    OSHashNode* node = NULL;
    os_calloc(1, sizeof(OSHashNode), node);
    if (!node || (OS_INVALID == build_test_hash_node(node, VU_SRC_NVD)))
        return;

    vu_report *report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if(!report)
        return;

    os_strdup("CVE-2016-6489", report->cve);

    will_return_always(__wrap_sqlite3_bind_text, 0);
    // vulnerability info query
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "The CVE title.");
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, vu_severities[VU_HIGH]);
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "2017-04-14");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, "2017-07-01");
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "The CVE description or rationale.");
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "6.9");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, "3.6");
    expect_value(__wrap_sqlite3_column_text, i, 7);
    will_return(__wrap_sqlite3_column_text, "AV:N/AC:M/Au:N/C:N/I:N/A:C");
    expect_value(__wrap_sqlite3_column_text, i, 8);
    will_return(__wrap_sqlite3_column_text, "CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H");
    expect_value(__wrap_sqlite3_column_text, i, 9);
    will_return(__wrap_sqlite3_column_text, "CWE-502");
    //Query for references
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "http://rhn.redhat.com/errata/RHSA-2016-2582.html");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);
    //Query for bugzilla references error
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);

    int ret = wm_vuldet_fill_report_oval_data(db, stmt, agent, ((cve_vuln_pkg*)node->data)->next, report);

    assert_int_equal(ret, SQLITE_ERROR);

    wm_vuldet_free_cve_node(node->data);
    os_free(node->key);
    os_free(node);
    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_oval_data_advisories_error(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    agent->dist = FEED_UBUNTU;
    agent->dist_ver = FEED_FOCAL;

    OSHashNode* node = NULL;
    os_calloc(1, sizeof(OSHashNode), node);
    if (!node || (OS_INVALID == build_test_hash_node(node, VU_SRC_NVD)))
        return;

    vu_report *report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if(!report)
        return;

    os_strdup("CVE-2016-6489", report->cve);

    will_return_always(__wrap_sqlite3_bind_text, 0);
    // vulnerability info query
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "The CVE title.");
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, vu_severities[VU_HIGH]);
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "2017-04-14");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, "2017-07-01");
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "The CVE description or rationale.");
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "6.9");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, "3.6");
    expect_value(__wrap_sqlite3_column_text, i, 7);
    will_return(__wrap_sqlite3_column_text, "AV:N/AC:M/Au:N/C:N/I:N/A:C");
    expect_value(__wrap_sqlite3_column_text, i, 8);
    will_return(__wrap_sqlite3_column_text, "CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H");
    expect_value(__wrap_sqlite3_column_text, i, 9);
    will_return(__wrap_sqlite3_column_text, "CWE-502");
    //Query for references
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "http://rhn.redhat.com/errata/RHSA-2016-2582.html");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);
    //Query for bugzilla references
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "http://rhn.redhat.org/cgi-bin/bugreport.cgi?bug=925286");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);
    //Query for advisories error
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);

    int ret = wm_vuldet_fill_report_oval_data(db, stmt, agent, ((cve_vuln_pkg*)node->data)->next, report);

    assert_int_equal(ret, SQLITE_ERROR);

    wm_vuldet_free_cve_node(node->data);
    os_free(node->key);
    os_free(node);
    wm_vuldet_free_report(report);
}

void test_wm_vuldet_fill_report_oval_data(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;
    sqlite3_stmt *stmt = NULL;

    agent->dist = FEED_UBUNTU;
    agent->dist_ver = FEED_FOCAL;

    OSHashNode* node = NULL;
    os_calloc(1, sizeof(OSHashNode), node);
    if (!node || (OS_INVALID == build_test_hash_node(node, VU_SRC_OVAL)))
        return;

    vu_report *report = NULL;
    os_calloc(1, sizeof(vu_report), report);
    if(!report)
        return;

    os_strdup("CVE-2016-6489", report->cve);

    will_return_always(__wrap_sqlite3_bind_text, 0);
    // vulnerability info query
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "The CVE title.");
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, vu_severities[VU_HIGH]);
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "2017-04-14");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, "2017-07-01");
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "The CVE description or rationale.");
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "6.9");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, "3.6");
    expect_value(__wrap_sqlite3_column_text, i, 7);
    will_return(__wrap_sqlite3_column_text, "AV:N/AC:M/Au:N/C:N/I:N/A:C");
    expect_value(__wrap_sqlite3_column_text, i, 8);
    will_return(__wrap_sqlite3_column_text, "CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H");
    expect_value(__wrap_sqlite3_column_text, i, 9);
    will_return(__wrap_sqlite3_column_text, "CWE-502");
    //Query for references
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "http://rhn.redhat.com/errata/RHSA-2016-2582.html");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "http://rhn.redhat.com/errata/RHSA-2016-2582.html");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);
    //Query for bugzilla references
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "http://rhn.redhat.org/cgi-bin/bugreport.cgi?bug=925286");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);
    //Query for advisories
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "RHSA-2020:0975");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    int ret = wm_vuldet_fill_report_oval_data(db, stmt, agent, ((cve_vuln_pkg*)node->data)->next, report);

    assert_int_equal(ret, SQLITE_OK);

    wm_vuldet_free_cve_node(node->data);
    os_free(node->key);
    os_free(node);
    wm_vuldet_free_report(report);
}

/* wm_vuldet_send_agent_report */

void test_wm_vuldet_send_agent_report_no_hash_node_rh(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;
    OSHash *cve_table = (OSHash *)1;

    wm_vuldet_flags *flags = (wm_vuldet_flags*)1;

    agent->dist = FEED_REDHAT;

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5466): Sending vulnerabilities report for agent '000'");
    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5482): A total of '0' vulnerabilities have been reported for agent '000' thanks to the 'NVD' feed.");
    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5482): A total of '0' vulnerabilities have been reported for agent '000' thanks to the 'vendor' feed.");
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5469): A total of '0' vulnerabilities have been reported for agent '000'");
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5470): It took '0' seconds to 'report' vulnerabilities in agent '000'");

    will_return(__wrap_OSHash_Begin, NULL);

    int ret = wm_vuldet_send_agent_report(db, cve_table, agent, flags);

    assert_int_equal(ret, OS_SUCCESS);
}

void test_wm_vuldet_send_agent_report_no_hash_node_ubuntu(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;
    OSHash *cve_table = (OSHash *)1;

    wm_vuldet_flags *flags = (wm_vuldet_flags*)1;

    agent->dist = FEED_UBUNTU;
    agent->dist_ver = FEED_FOCAL;

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5466): Sending vulnerabilities report for agent '000'");
    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5482): A total of '0' vulnerabilities have been reported for agent '000' thanks to the 'NVD' feed.");
    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5482): A total of '0' vulnerabilities have been reported for agent '000' thanks to the 'vendor' feed.");
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5469): A total of '0' vulnerabilities have been reported for agent '000'");
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5470): It took '0' seconds to 'report' vulnerabilities in agent '000'");

    will_return(__wrap_OSHash_Begin, NULL);

    int ret = wm_vuldet_send_agent_report(db, cve_table, agent, flags);

    assert_int_equal(ret, OS_SUCCESS);
}

void test_wm_vuldet_send_agent_report_fill_report_nvd_cve_info_error(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;
    OSHash *cve_table = (OSHash *)1;

    wm_vuldet_flags *flags = calloc(1, sizeof(wm_vuldet_flags));
    if(!flags) {
        return;
    }
    flags->report_kernel_os_package = 1;

    agent->dist = FEED_UBUNTU;
    agent->dist_ver = FEED_FOCAL;

    OSHashNode* node = NULL;
    os_calloc(1, sizeof(OSHashNode), node);
    if (!node || (OS_INVALID == build_test_hash_node(node, VU_SRC_NVD|VU_SRC_OVAL)))
        return;

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5466): Sending vulnerabilities report for agent '000'");
    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5578): Could not fill the report with the CVE info from the NVD for agent '000'");

    will_return(__wrap_OSHash_Begin, node);
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);
    will_return(__wrap_sqlite3_errmsg, "error");
    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5503): SQL error: 'error'");
    will_return(__wrap_sqlite3_close_v2, SQLITE_OK);

    int ret = wm_vuldet_send_agent_report(db, cve_table, agent, flags);

    assert_int_equal(ret, OS_INVALID);

    wm_vuldet_free_cve_node(node->data);
    os_free(node->key);
    os_free(node);
    os_free(flags);
}

void test_wm_vuldet_send_agent_report_fill_report_nvd_references_error(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;
    OSHash *cve_table = (OSHash *)1;

    wm_vuldet_flags *flags = calloc(1, sizeof(wm_vuldet_flags));
    if(!flags) {
        return;
    }
    flags->report_kernel_os_package = 1;

    agent->dist = FEED_UBUNTU;
    agent->dist_ver = FEED_FOCAL;

    OSHashNode* node = NULL;
    os_calloc(1, sizeof(OSHashNode), node);
    if (!node || (OS_INVALID == build_test_hash_node(node, VU_SRC_NVD|VU_SRC_OVAL)))
        return;

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5466): Sending vulnerabilities report for agent '000'");
    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5579): Could not fill the report with the CVE references from the NVD for agent '000'");

    will_return(__wrap_OSHash_Begin, node);
    will_return_always(__wrap_sqlite3_bind_text, 0);
    // CVE info query
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "1");
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, "CWE-502");
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "cve@mitre.org");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, "The CVE description or rationale.");
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "4.0");
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "2017-04-14");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, "2017-07-01");
    //Query for references error
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);
    will_return(__wrap_sqlite3_errmsg, "error");
    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5503): SQL error: 'error'");
    will_return(__wrap_sqlite3_close_v2, SQLITE_OK);

    int ret = wm_vuldet_send_agent_report(db, cve_table, agent, flags);

    assert_int_equal(ret, OS_INVALID);

    wm_vuldet_free_cve_node(node->data);
    os_free(node->key);
    os_free(node);
    os_free(flags);
}

void test_wm_vuldet_send_agent_report_fill_report_nvd_scoring_error(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;
    OSHash *cve_table = (OSHash *)1;

    wm_vuldet_flags *flags = calloc(1, sizeof(wm_vuldet_flags));
    if(!flags) {
        return;
    }
    flags->report_kernel_os_package = 1;

    agent->dist = FEED_UBUNTU;
    agent->dist_ver = FEED_FOCAL;

    OSHashNode* node = NULL;
    os_calloc(1, sizeof(OSHashNode), node);
    if (!node || (OS_INVALID == build_test_hash_node(node, VU_SRC_NVD)))
        return;

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5466): Sending vulnerabilities report for agent '000'");
    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5580): Could not fill the report with the CVE score from the NVD for agent '000'");

    will_return(__wrap_OSHash_Begin, node);
    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    // CVE info query
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "1");
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, "CWE-502");
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "cve@mitre.org");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, "The CVE description or rationale.");
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "4.0");
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "2017-04-14");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, "2017-07-01");
    //Query for references
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_int, a, 1);
    expect_value(__wrap_sqlite3_bind_int, b, 1);
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "http://rhn.redhat.com/errata/RHSA-2016-2582.html");
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, "REDHAT");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);
    //Query for scoring error
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);
    will_return(__wrap_sqlite3_errmsg, "error");
    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5503): SQL error: 'error'");
    will_return(__wrap_sqlite3_close_v2, SQLITE_OK);

    int ret = wm_vuldet_send_agent_report(db, cve_table, agent, flags);

    assert_int_equal(ret, OS_INVALID);

    wm_vuldet_free_cve_node(node->data);
    os_free(node->key);
    os_free(node);
    os_free(flags);
}

void test_wm_vuldet_send_agent_report_fill_report_oval_error(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;
    OSHash *cve_table = (OSHash *)1;

    wm_vuldet_flags *flags = calloc(1, sizeof(wm_vuldet_flags));
    if(!flags) {
        return;
    }
    flags->report_kernel_os_package = 1;

    agent->dist = FEED_UBUNTU;
    agent->dist_ver = FEED_FOCAL;

    OSHashNode* node = NULL;
    os_calloc(1, sizeof(OSHashNode), node);
    if (!node || (OS_INVALID == build_test_hash_node(node, VU_SRC_OVAL)))
        return;

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5466): Sending vulnerabilities report for agent '000'");
    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5578): Could not fill the report with the CVE info from the NVD for agent '000'");

    will_return(__wrap_OSHash_Begin, node);
    //Prepare oval query error
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);
    will_return(__wrap_sqlite3_errmsg, "error");
    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5503): SQL error: 'error'");
    will_return(__wrap_sqlite3_close_v2, SQLITE_OK);

    int ret = wm_vuldet_send_agent_report(db, cve_table, agent, flags);

    assert_int_equal(ret, OS_INVALID);

    wm_vuldet_free_cve_node(node->data);
    os_free(node->key);
    os_free(node);
    os_free(flags);
}

void test_wm_vuldet_send_agent_send_cve_report(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;
    OSHash *cve_table = (OSHash *)1;

    wm_vuldet_flags *flags = calloc(1, sizeof(wm_vuldet_flags));
    if(!flags) {
        return;
    }
    flags->report_kernel_os_package = 1;

    wm_max_eps = 1000000;

    agent->dist = FEED_UBUNTU;
    agent->dist_ver = FEED_FOCAL;

    OSHashNode* node = NULL;
    os_calloc(1, sizeof(OSHashNode), node);
    if (!node || (OS_INVALID == build_test_hash_node(node, VU_SRC_OVAL)))
        return;

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5466): Sending vulnerabilities report for agent '000'");

    will_return(__wrap_OSHash_Begin, node);
    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    // CVE info query
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "1");
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, "CWE-502");
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "cve@mitre.org");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, "The CVE description or rationale.");
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "4.0");
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "2017-04-14");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, "2017-07-01");
    //Query for references
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_int, a, 1);
    expect_value(__wrap_sqlite3_bind_int, b, 1);
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "http://rhn.redhat.com/errata/RHSA-2016-2582.html");
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, "REDHAT");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);
    //Query for scoring
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_int, a, 1);
    expect_value(__wrap_sqlite3_bind_int, b, 1  );
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "");
    expect_value(__wrap_sqlite3_column_double, i, 1);
    will_return(__wrap_sqlite3_column_double, 0);
    expect_value(__wrap_sqlite3_column_double, i, 2);
    will_return(__wrap_sqlite3_column_double, 0);
    expect_value(__wrap_sqlite3_column_double, i, 3);
    will_return(__wrap_sqlite3_column_double, 0);
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, NULL);
    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    // Query for oval data
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "The CVE title.");
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, vu_severities[VU_HIGH]);
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "2017-04-14");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, "2017-07-01");
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "The CVE description or rationale.");
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "6.9");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, "3.6");
    expect_value(__wrap_sqlite3_column_text, i, 7);
    will_return(__wrap_sqlite3_column_text, "AV:N/AC:M/Au:N/C:N/I:N/A:C");
    expect_value(__wrap_sqlite3_column_text, i, 8);
    will_return(__wrap_sqlite3_column_text, "CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H");
    expect_value(__wrap_sqlite3_column_text, i, 9);
    will_return(__wrap_sqlite3_column_text, "CWE-502");
    //Query for oval references
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "http://rhn.redhat.com/errata/RHSA-2016-2582.html");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);
    //Query for oval bugzilla references
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "http://rhn.redhat.org/cgi-bin/bugreport.cgi?bug=925286");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);
    //Query for oval advisories
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "RHSA-2020:0975");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);
    // Sending CVE report
    will_return(__wrap_cJSON_CreateObject, NULL);
    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5559): Could not send the 'CVE-2016-6489' report for 'libhogweed4' in the agent '000'");
    will_return(__wrap_OSHash_Next, NULL);

    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5482): A total of '0' vulnerabilities have been reported for agent '000' thanks to the 'NVD' feed.");
    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5482): A total of '0' vulnerabilities have been reported for agent '000' thanks to the 'vendor' feed.");
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5469): A total of '0' vulnerabilities have been reported for agent '000'");
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5470): It took '0' seconds to 'report' vulnerabilities in agent '000'");

    int ret = wm_vuldet_send_agent_report(db, cve_table, agent, flags);

    assert_int_equal(ret, OS_SUCCESS);

    wm_vuldet_free_cve_node(node->data);
    os_free(node->key);
    os_free(node);
    os_free(flags);
}

/* wm_vuldet_get_cvss */

void test_wm_vuldet_get_cvss_null(void ** state)
{
    const char *cvss_vector = NULL;

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_null(ret);
}

void test_wm_vuldet_get_cvss_error_cvss_json(void ** state)
{
    const char *cvss_vector = "AV:N/AC:M/Au:N/C:N/I:N/A:C";

    will_return(__wrap_cJSON_CreateObject, NULL);

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_null(ret);
}

void test_wm_vuldet_get_cvss_attack_vector_local(void ** state)
{
    const char *cvss_vector = "AV:L";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "local");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_attack_vector_adjacent_network(void ** state)
{
    const char *cvss_vector = "AV:A";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "adjacent_network");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_attack_vector_network(void ** state)
{
    const char *cvss_vector = "AV:N";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_attack_vector_physiscal(void ** state)
{
    const char *cvss_vector = "AV:P";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "physical");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_access_complexity_low(void ** state)
{
    const char *cvss_vector = "AC:L";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "low");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_access_complexity_medium(void ** state)
{
    const char *cvss_vector = "AC:M";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "medium");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_access_complexity_high(void ** state)
{
    const char *cvss_vector = "AC:H";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_authentication_multiple(void ** state)
{
    const char *cvss_vector = "Au:M";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "authentication");
    expect_string(__wrap_cJSON_AddStringToObject, string, "multiple");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_authentication_single(void ** state)
{
    const char *cvss_vector = "Au:S";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "authentication");
    expect_string(__wrap_cJSON_AddStringToObject, string, "single");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_authentication_none(void ** state)
{
    const char *cvss_vector = "Au:N";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "authentication");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_confidentiality_impact_none(void ** state)
{
    const char *cvss_vector = "C:N";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_confidentiality_impact_partial(void ** state)
{
    const char *cvss_vector = "C:P";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "partial");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_confidentiality_impact_complete(void ** state)
{
    const char *cvss_vector = "C:C";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "complete");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_confidentiality_impact_low(void ** state)
{
    const char *cvss_vector = "C:L";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "low");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_confidentiality_impact_high(void ** state)
{
    const char *cvss_vector = "C:H";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_integrity_impact_none(void ** state)
{
    const char *cvss_vector = "I:N";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_integrity_impact_partial(void ** state)
{
    const char *cvss_vector = "I:P";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "partial");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_integrity_impact_complete(void ** state)
{
    const char *cvss_vector = "I:C";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "complete");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_integrity_impact_low(void ** state)
{
    const char *cvss_vector = "I:L";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "low");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_integrity_impact_high(void ** state)
{
    const char *cvss_vector = "I:H";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_availability_none(void ** state)
{
    const char *cvss_vector = "A:N";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_availability_partial(void ** state)
{
    const char *cvss_vector = "A:P";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "partial");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_availability_complete(void ** state)
{
    const char *cvss_vector = "A:C";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "complete");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_availability_low(void ** state)
{
    const char *cvss_vector = "A:L";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "low");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_availability_high(void ** state)
{
    const char *cvss_vector = "A:H";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_privileges_required_none(void ** state)
{
    const char *cvss_vector = "PR:N";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "privileges_required");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_privileges_required_partial(void ** state)
{
    const char *cvss_vector = "PR:P";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "privileges_required");
    expect_string(__wrap_cJSON_AddStringToObject, string, "partial");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_privileges_required_complete(void ** state)
{
    const char *cvss_vector = "PR:C";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "privileges_required");
    expect_string(__wrap_cJSON_AddStringToObject, string, "complete");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_privileges_required_low(void ** state)
{
    const char *cvss_vector = "PR:L";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "privileges_required");
    expect_string(__wrap_cJSON_AddStringToObject, string, "low");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_privileges_required_high(void ** state)
{
    const char *cvss_vector = "PR:H";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "privileges_required");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_user_interaction_none(void ** state)
{
    const char *cvss_vector = "UI:N";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "user_interaction");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_user_interaction_required(void ** state)
{
    const char *cvss_vector = "UI:R";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "user_interaction");
    expect_string(__wrap_cJSON_AddStringToObject, string, "required");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_scope_unchanged(void ** state)
{
    const char *cvss_vector = "S:U";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "scope");
    expect_string(__wrap_cJSON_AddStringToObject, string, "unchanged");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_scope_changed(void ** state)
{
    const char *cvss_vector = "S:C";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "scope");
    expect_string(__wrap_cJSON_AddStringToObject, string, "changed");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_v2(void ** state)
{
    const char *cvss_vector = "AV:N/AC:M/Au:N/C:N/I:N/A:C";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "medium");
    expect_string(__wrap_cJSON_AddStringToObject, name, "authentication");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "complete");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

void test_wm_vuldet_get_cvss_v3(void ** state)
{
    const char *cvss_vector = "AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H";
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");
    expect_string(__wrap_cJSON_AddStringToObject, name, "privileges_required");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "user_interaction");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "scope");
    expect_string(__wrap_cJSON_AddStringToObject, string, "unchanged");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");

    cJSON *ret = wm_vuldet_get_cvss(cvss_vector);

    assert_non_null(ret);
}

/* wm_vuldet_send_cve_report */

void test_wm_vuldet_send_cve_report_error_alert_create(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    will_return(__wrap_cJSON_CreateObject, NULL);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, OS_INVALID);
}

void test_wm_vuldet_send_cve_report_error_alert_cve_create(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    cJSON* alert = (cJSON *)1;
    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, NULL);
    expect_function_call(__wrap_cJSON_Delete);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, OS_INVALID);
}

void test_wm_vuldet_send_cve_report_error_j_package_create(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    cJSON* alert = (cJSON *)1;
    cJSON* alert_cve = (cJSON *)1;
    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    //Creating packaje objects
    will_return(__wrap_cJSON_CreateObject, NULL);
    expect_function_call(__wrap_cJSON_Delete);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, OS_INVALID);
}

void test_wm_vuldet_send_cve_report_error_j_cvss_create(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    if (OS_INVALID == build_test_cve_report(report, 1, 1, 1, 1))
        return;

    cJSON* alert = (cJSON *)1;
    cJSON* alert_cve = (cJSON *)1;
    cJSON* j_package = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding package information
    will_return(__wrap_cJSON_CreateObject, j_package);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_string(__wrap_cJSON_AddStringToObject, name, "name");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->software);
    expect_string(__wrap_cJSON_AddStringToObject, name, "source");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->source);
    expect_string(__wrap_cJSON_AddStringToObject, name, "version");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->version);
    expect_string(__wrap_cJSON_AddStringToObject, name, "generated_cpe");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->generated_cpe);
    expect_string(__wrap_cJSON_AddStringToObject, name, "architecture");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->arch);
    expect_string(__wrap_cJSON_AddStringToObject, name, "condition");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->condition);
    //Creating cvss objects
    will_return(__wrap_cJSON_CreateObject, NULL);
    expect_function_call(__wrap_cJSON_Delete);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, OS_INVALID);
}

void test_wm_vuldet_send_cve_report_error_j_cvss_node_create(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    if (OS_INVALID == build_test_cve_report(report, 1, 1, 1, 1))
        return;

    cJSON* alert = (cJSON *)1;
    cJSON* alert_cve = (cJSON *)1;
    cJSON* j_package = (cJSON *)1;
    cJSON* j_cvss = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding package information
    will_return(__wrap_cJSON_CreateObject, j_package);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_string(__wrap_cJSON_AddStringToObject, name, "name");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->software);
    expect_string(__wrap_cJSON_AddStringToObject, name, "source");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->source);
    expect_string(__wrap_cJSON_AddStringToObject, name, "version");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->version);
    expect_string(__wrap_cJSON_AddStringToObject, name, "generated_cpe");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->generated_cpe);
    expect_string(__wrap_cJSON_AddStringToObject, name, "architecture");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->arch);
    expect_string(__wrap_cJSON_AddStringToObject, name, "condition");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->condition);
    //Creating cvss objects
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, NULL);
    expect_function_call(__wrap_cJSON_Delete);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, OS_INVALID);
}

void test_wm_vuldet_send_cve_report_error_j_advisories_create(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    if (OS_INVALID == build_test_cve_report(report, 1, 1, 1, 1))
        return;

    cJSON* alert = (cJSON *)1;
    cJSON* alert_cve = (cJSON *)1;
    cJSON* j_package = (cJSON *)1;
    cJSON* j_cvss = (cJSON *)1;
    cJSON* j_cvss_node = (cJSON *)1;
    cJSON* cvss_json = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding package information
    will_return(__wrap_cJSON_CreateObject, j_package);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_string(__wrap_cJSON_AddStringToObject, name, "name");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->software);
    expect_string(__wrap_cJSON_AddStringToObject, name, "source");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->source);
    expect_string(__wrap_cJSON_AddStringToObject, name, "version");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->version);
    expect_string(__wrap_cJSON_AddStringToObject, name, "generated_cpe");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->generated_cpe);
    expect_string(__wrap_cJSON_AddStringToObject, name, "architecture");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->arch);
    expect_string(__wrap_cJSON_AddStringToObject, name, "condition");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->condition);
    // Adding cvss information
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "medium");
    expect_string(__wrap_cJSON_AddStringToObject, name, "authentication");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "complete");
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 7.1);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 8.6);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 6.9);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");
    expect_string(__wrap_cJSON_AddStringToObject, name, "privileges_required");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "user_interaction");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "scope");
    expect_string(__wrap_cJSON_AddStringToObject, string, "unchanged");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 5.9);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 2.2);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 3.6);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding CVE information
    expect_string(__wrap_cJSON_AddStringToObject, name, "cve");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cve);
    expect_string(__wrap_cJSON_AddStringToObject, name, "title");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->title);
    expect_string(__wrap_cJSON_AddStringToObject, name, "rationale");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->rationale);
    expect_string(__wrap_cJSON_AddStringToObject, name, "severity");
    expect_string(__wrap_cJSON_AddStringToObject, string, vu_severities[VU_HIGH]);
    expect_string(__wrap_cJSON_AddStringToObject, name, "published");
    expect_string(__wrap_cJSON_AddStringToObject, string, "2020-03-05T15:15:00Z");
    expect_string(__wrap_cJSON_AddStringToObject, name, "updated");
    expect_string(__wrap_cJSON_AddStringToObject, string, "2020-05-25T15:15:00Z");
    expect_string(__wrap_cJSON_AddStringToObject, name, "state");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->state);
    expect_string(__wrap_cJSON_AddStringToObject, name, "cwe_reference");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cwe);
    // Adding advisories data
    will_return(__wrap_cJSON_CreateArray, NULL);
    expect_function_call(__wrap_cJSON_Delete);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, OS_INVALID);
}

void test_wm_vuldet_send_cve_report_error_j_bug_references_create(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    if (OS_INVALID == build_test_cve_report(report, 1, 1, 1, 1))
        return;

    cJSON* alert = (cJSON *)1;
    cJSON* alert_cve = (cJSON *)1;
    cJSON* j_package = (cJSON *)1;
    cJSON* j_cvss = (cJSON *)1;
    cJSON* j_cvss_node = (cJSON *)1;
    cJSON* cvss_json = (cJSON *)1;
    cJSON* j_advisories = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding package information
    will_return(__wrap_cJSON_CreateObject, j_package);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_string(__wrap_cJSON_AddStringToObject, name, "name");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->software);
    expect_string(__wrap_cJSON_AddStringToObject, name, "source");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->source);
    expect_string(__wrap_cJSON_AddStringToObject, name, "version");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->version);
    expect_string(__wrap_cJSON_AddStringToObject, name, "generated_cpe");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->generated_cpe);
    expect_string(__wrap_cJSON_AddStringToObject, name, "architecture");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->arch);
    expect_string(__wrap_cJSON_AddStringToObject, name, "condition");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->condition);
    // Adding cvss information
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "medium");
    expect_string(__wrap_cJSON_AddStringToObject, name, "authentication");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "complete");
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 7.1);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 8.6);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 6.9);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");
    expect_string(__wrap_cJSON_AddStringToObject, name, "privileges_required");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "user_interaction");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "scope");
    expect_string(__wrap_cJSON_AddStringToObject, string, "unchanged");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 5.9);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 2.2);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 3.6);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding CVE information
    expect_string(__wrap_cJSON_AddStringToObject, name, "cve");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cve);
    expect_string(__wrap_cJSON_AddStringToObject, name, "title");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->title);
    expect_string(__wrap_cJSON_AddStringToObject, name, "rationale");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->rationale);
    expect_string(__wrap_cJSON_AddStringToObject, name, "severity");
    expect_string(__wrap_cJSON_AddStringToObject, string, vu_severities[VU_HIGH]);
    expect_string(__wrap_cJSON_AddStringToObject, name, "published");
    expect_string(__wrap_cJSON_AddStringToObject, string, "2020-03-05T15:15:00Z");
    expect_string(__wrap_cJSON_AddStringToObject, name, "updated");
    expect_string(__wrap_cJSON_AddStringToObject, string, "2020-05-25T15:15:00Z");
    expect_string(__wrap_cJSON_AddStringToObject, name, "state");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->state);
    expect_string(__wrap_cJSON_AddStringToObject, name, "cwe_reference");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cwe);
    // Adding advisories data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "RHSA-2020:0975");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding bugzilla references data
    will_return(__wrap_cJSON_CreateArray, NULL);
    expect_function_call(__wrap_cJSON_Delete);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, OS_INVALID);
}

void test_wm_vuldet_send_cve_report_error_j_references_create(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    if (OS_INVALID == build_test_cve_report(report, 1, 1, 1, 1))
        return;

    cJSON* alert = (cJSON *)1;
    cJSON* alert_cve = (cJSON *)1;
    cJSON* j_package = (cJSON *)1;
    cJSON* j_cvss = (cJSON *)1;
    cJSON* j_cvss_node = (cJSON *)1;
    cJSON* cvss_json = (cJSON *)1;
    cJSON* j_advisories = (cJSON *)1;

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding package information
    will_return(__wrap_cJSON_CreateObject, j_package);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_string(__wrap_cJSON_AddStringToObject, name, "name");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->software);
    expect_string(__wrap_cJSON_AddStringToObject, name, "source");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->source);
    expect_string(__wrap_cJSON_AddStringToObject, name, "version");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->version);
    expect_string(__wrap_cJSON_AddStringToObject, name, "generated_cpe");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->generated_cpe);
    expect_string(__wrap_cJSON_AddStringToObject, name, "architecture");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->arch);
    expect_string(__wrap_cJSON_AddStringToObject, name, "condition");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->condition);
    // Adding cvss information
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "medium");
    expect_string(__wrap_cJSON_AddStringToObject, name, "authentication");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "complete");
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 7.1);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 8.6);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 6.9);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");
    expect_string(__wrap_cJSON_AddStringToObject, name, "privileges_required");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "user_interaction");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "scope");
    expect_string(__wrap_cJSON_AddStringToObject, string, "unchanged");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 5.9);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 2.2);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 3.6);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding CVE information
    expect_string(__wrap_cJSON_AddStringToObject, name, "cve");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cve);
    expect_string(__wrap_cJSON_AddStringToObject, name, "title");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->title);
    expect_string(__wrap_cJSON_AddStringToObject, name, "rationale");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->rationale);
    expect_string(__wrap_cJSON_AddStringToObject, name, "severity");
    expect_string(__wrap_cJSON_AddStringToObject, string, vu_severities[VU_HIGH]);
    expect_string(__wrap_cJSON_AddStringToObject, name, "published");
    expect_string(__wrap_cJSON_AddStringToObject, string, "2020-03-05T15:15:00Z");
    expect_string(__wrap_cJSON_AddStringToObject, name, "updated");
    expect_string(__wrap_cJSON_AddStringToObject, string, "2020-05-25T15:15:00Z");
    expect_string(__wrap_cJSON_AddStringToObject, name, "state");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->state);
    expect_string(__wrap_cJSON_AddStringToObject, name, "cwe_reference");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cwe);
    // Adding advisories data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "RHSA-2020:0975");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding bugzilla references data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "http://rhn.redhat.org/cgi-bin/bugreport.cgi?bug=925286");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding references data
    will_return(__wrap_cJSON_CreateArray, NULL);
    expect_function_call(__wrap_cJSON_Delete);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, OS_INVALID);
}

void test_wm_vuldet_send_cve_report_without_title(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    if (OS_INVALID == build_test_cve_report(report, 0, 1, 1, 1))
        return;

    cJSON* alert = (cJSON *)1;
    cJSON* alert_cve = (cJSON *)1;
    cJSON* j_package = (cJSON *)1;
    cJSON* j_cvss = (cJSON *)1;
    cJSON* j_cvss_node = (cJSON *)1;
    cJSON* cvss_json = (cJSON *)1;
    cJSON* j_advisories = (cJSON *)1;

    char *json_text = NULL;
    os_strdup("{\"title\": \"vulnerability detector alert json\"}", json_text);

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding package information
    will_return(__wrap_cJSON_CreateObject, j_package);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_string(__wrap_cJSON_AddStringToObject, name, "name");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->software);
    expect_string(__wrap_cJSON_AddStringToObject, name, "source");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->source);
    expect_string(__wrap_cJSON_AddStringToObject, name, "version");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->version);
    expect_string(__wrap_cJSON_AddStringToObject, name, "generated_cpe");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->generated_cpe);
    expect_string(__wrap_cJSON_AddStringToObject, name, "architecture");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->arch);
    expect_string(__wrap_cJSON_AddStringToObject, name, "condition");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->condition);
    // Adding cvss information
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "medium");
    expect_string(__wrap_cJSON_AddStringToObject, name, "authentication");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "complete");
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 7.1);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 8.6);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 6.9);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");
    expect_string(__wrap_cJSON_AddStringToObject, name, "privileges_required");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "user_interaction");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "scope");
    expect_string(__wrap_cJSON_AddStringToObject, string, "unchanged");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 5.9);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 2.2);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 3.6);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding CVE information
    expect_string(__wrap_cJSON_AddStringToObject, name, "cve");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cve);
    expect_string(__wrap_cJSON_AddStringToObject, name, "title");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->rationale);
    expect_string(__wrap_cJSON_AddStringToObject, name, "severity");
    expect_string(__wrap_cJSON_AddStringToObject, string, vu_severities[VU_HIGH]);
    expect_string(__wrap_cJSON_AddStringToObject, name, "published");
    expect_string(__wrap_cJSON_AddStringToObject, string, "2020-03-05T15:15:00Z");
    expect_string(__wrap_cJSON_AddStringToObject, name, "updated");
    expect_string(__wrap_cJSON_AddStringToObject, string, "2020-05-25T15:15:00Z");
    expect_string(__wrap_cJSON_AddStringToObject, name, "state");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->state);
    expect_string(__wrap_cJSON_AddStringToObject, name, "cwe_reference");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cwe);
    // Adding advisories data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "RHSA-2020:0975");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding bugzilla references data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "http://rhn.redhat.org/cgi-bin/bugreport.cgi?bug=925286");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding references data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "http://rhn.redhat.com/errata/RHSA-2016-2582.html");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_string(__wrap_cJSON_AddStringToObject, name, "assigner");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->assigner);
    expect_string(__wrap_cJSON_AddStringToObject, name, "cve_version");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cve_version);
    will_return(__wrap_cJSON_PrintUnformatted, json_text);

    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5467): Agent '001' is vulnerable to 'CVE-2016-6489'. Condition: 'Package less than 4.3-2'");

    will_return(__wrap_SendMSG, OS_SUCCESS);

    expect_function_call(__wrap_cJSON_Delete);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, OS_SUCCESS);
}

void test_wm_vuldet_send_cve_report_without_condition(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    if (OS_INVALID == build_test_cve_report(report, 1, 0, 1, 1))
        return;

    cJSON* alert = (cJSON *)1;
    cJSON* alert_cve = (cJSON *)1;
    cJSON* j_package = (cJSON *)1;
    cJSON* j_cvss = (cJSON *)1;
    cJSON* j_cvss_node = (cJSON *)1;
    cJSON* cvss_json = (cJSON *)1;
    cJSON* j_advisories = (cJSON *)1;

    char *json_text = NULL;
    os_strdup("{\"title\": \"vulnerability detector alert json\"}", json_text);

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding package information
    will_return(__wrap_cJSON_CreateObject, j_package);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_string(__wrap_cJSON_AddStringToObject, name, "name");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->software);
    expect_string(__wrap_cJSON_AddStringToObject, name, "source");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->source);
    expect_string(__wrap_cJSON_AddStringToObject, name, "version");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->version);
    expect_string(__wrap_cJSON_AddStringToObject, name, "generated_cpe");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->generated_cpe);
    expect_string(__wrap_cJSON_AddStringToObject, name, "architecture");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->arch);
    expect_string(__wrap_cJSON_AddStringToObject, name, "condition");
    expect_string(__wrap_cJSON_AddStringToObject, string, "Package CVE-2016-6489 reports as vulnerable all the versions of this package 4.3-2");
    // Adding cvss information
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "medium");
    expect_string(__wrap_cJSON_AddStringToObject, name, "authentication");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "complete");
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 7.1);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 8.6);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 6.9);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");
    expect_string(__wrap_cJSON_AddStringToObject, name, "privileges_required");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "user_interaction");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "scope");
    expect_string(__wrap_cJSON_AddStringToObject, string, "unchanged");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 5.9);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 2.2);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 3.6);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding CVE information
    expect_string(__wrap_cJSON_AddStringToObject, name, "cve");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cve);
    expect_string(__wrap_cJSON_AddStringToObject, name, "title");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->title);
    expect_string(__wrap_cJSON_AddStringToObject, name, "rationale");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->rationale);
    expect_string(__wrap_cJSON_AddStringToObject, name, "severity");
    expect_string(__wrap_cJSON_AddStringToObject, string, vu_severities[VU_HIGH]);
    expect_string(__wrap_cJSON_AddStringToObject, name, "published");
    expect_string(__wrap_cJSON_AddStringToObject, string, "2020-03-05T15:15:00Z");
    expect_string(__wrap_cJSON_AddStringToObject, name, "updated");
    expect_string(__wrap_cJSON_AddStringToObject, string, "2020-05-25T15:15:00Z");
    expect_string(__wrap_cJSON_AddStringToObject, name, "state");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->state);
    expect_string(__wrap_cJSON_AddStringToObject, name, "cwe_reference");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cwe);
    // Adding advisories data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "RHSA-2020:0975");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding bugzilla references data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "http://rhn.redhat.org/cgi-bin/bugreport.cgi?bug=925286");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding references data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "http://rhn.redhat.com/errata/RHSA-2016-2582.html");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_string(__wrap_cJSON_AddStringToObject, name, "assigner");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->assigner);
    expect_string(__wrap_cJSON_AddStringToObject, name, "cve_version");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cve_version);
    will_return(__wrap_cJSON_PrintUnformatted, json_text);

    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5467): Agent '001' is vulnerable to 'CVE-2016-6489'. Condition: 'Package CVE-2016-6489 reports as vulnerable all the versions of this package 4.3-2'");

    will_return(__wrap_SendMSG, OS_SUCCESS);

    expect_function_call(__wrap_cJSON_Delete);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, OS_SUCCESS);
}

void test_wm_vuldet_send_cve_report_without_ip(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    if (OS_INVALID == build_test_cve_report(report, 1, 1, 0, 1))
        return;

    cJSON* alert = (cJSON *)1;
    cJSON* alert_cve = (cJSON *)1;
    cJSON* j_package = (cJSON *)1;
    cJSON* j_cvss = (cJSON *)1;
    cJSON* j_cvss_node = (cJSON *)1;
    cJSON* cvss_json = (cJSON *)1;
    cJSON* j_advisories = (cJSON *)1;

    char *json_text = NULL;
    os_strdup("{\"title\": \"vulnerability detector alert json\"}", json_text);

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding package information
    will_return(__wrap_cJSON_CreateObject, j_package);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_string(__wrap_cJSON_AddStringToObject, name, "name");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->software);
    expect_string(__wrap_cJSON_AddStringToObject, name, "source");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->source);
    expect_string(__wrap_cJSON_AddStringToObject, name, "version");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->version);
    expect_string(__wrap_cJSON_AddStringToObject, name, "generated_cpe");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->generated_cpe);
    expect_string(__wrap_cJSON_AddStringToObject, name, "architecture");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->arch);
    expect_string(__wrap_cJSON_AddStringToObject, name, "condition");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->condition);
    // Adding cvss information
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "medium");
    expect_string(__wrap_cJSON_AddStringToObject, name, "authentication");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "complete");
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 7.1);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 8.6);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 6.9);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");
    expect_string(__wrap_cJSON_AddStringToObject, name, "privileges_required");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "user_interaction");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "scope");
    expect_string(__wrap_cJSON_AddStringToObject, string, "unchanged");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 5.9);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 2.2);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 3.6);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding CVE information
    expect_string(__wrap_cJSON_AddStringToObject, name, "cve");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cve);
    expect_string(__wrap_cJSON_AddStringToObject, name, "title");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->title);
    expect_string(__wrap_cJSON_AddStringToObject, name, "rationale");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->rationale);
    expect_string(__wrap_cJSON_AddStringToObject, name, "severity");
    expect_string(__wrap_cJSON_AddStringToObject, string, vu_severities[VU_HIGH]);
    expect_string(__wrap_cJSON_AddStringToObject, name, "published");
    expect_string(__wrap_cJSON_AddStringToObject, string, "2020-03-05T15:15:00Z");
    expect_string(__wrap_cJSON_AddStringToObject, name, "updated");
    expect_string(__wrap_cJSON_AddStringToObject, string, "2020-05-25T15:15:00Z");
    expect_string(__wrap_cJSON_AddStringToObject, name, "state");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->state);
    expect_string(__wrap_cJSON_AddStringToObject, name, "cwe_reference");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cwe);
    // Adding advisories data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "RHSA-2020:0975");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding bugzilla references data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "http://rhn.redhat.org/cgi-bin/bugreport.cgi?bug=925286");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding references data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "http://rhn.redhat.com/errata/RHSA-2016-2582.html");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_string(__wrap_cJSON_AddStringToObject, name, "assigner");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->assigner);
    expect_string(__wrap_cJSON_AddStringToObject, name, "cve_version");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cve_version);
    will_return(__wrap_cJSON_PrintUnformatted, json_text);

    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5467): Agent '001' is vulnerable to 'CVE-2016-6489'. Condition: 'Package less than 4.3-2'");

    will_return(__wrap_SendMSG, OS_SUCCESS);

    expect_function_call(__wrap_cJSON_Delete);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, OS_SUCCESS);
}

void test_wm_vuldet_send_cve_report_without_hotfix(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    if (OS_INVALID == build_test_cve_report(report, 1, 1, 1, 0))
        return;

    cJSON* alert = (cJSON *)1;
    cJSON* alert_cve = (cJSON *)1;
    cJSON* j_package = (cJSON *)1;
    cJSON* j_cvss = (cJSON *)1;
    cJSON* j_cvss_node = (cJSON *)1;
    cJSON* cvss_json = (cJSON *)1;
    cJSON* j_advisories = (cJSON *)1;

    char *json_text = NULL;
    os_strdup("{\"title\": \"vulnerability detector alert json\"}", json_text);

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding package information
    will_return(__wrap_cJSON_CreateObject, j_package);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_string(__wrap_cJSON_AddStringToObject, name, "name");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->software);
    expect_string(__wrap_cJSON_AddStringToObject, name, "source");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->source);
    expect_string(__wrap_cJSON_AddStringToObject, name, "version");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->version);
    expect_string(__wrap_cJSON_AddStringToObject, name, "generated_cpe");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->generated_cpe);
    expect_string(__wrap_cJSON_AddStringToObject, name, "architecture");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->arch);
    expect_string(__wrap_cJSON_AddStringToObject, name, "condition");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->condition);
    // Adding cvss information
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "medium");
    expect_string(__wrap_cJSON_AddStringToObject, name, "authentication");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "complete");
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 7.1);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 8.6);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 6.9);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");
    expect_string(__wrap_cJSON_AddStringToObject, name, "privileges_required");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "user_interaction");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "scope");
    expect_string(__wrap_cJSON_AddStringToObject, string, "unchanged");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 5.9);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 2.2);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 3.6);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding CVE information
    expect_string(__wrap_cJSON_AddStringToObject, name, "cve");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cve);
    expect_string(__wrap_cJSON_AddStringToObject, name, "title");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->title);
    expect_string(__wrap_cJSON_AddStringToObject, name, "rationale");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->rationale);
    expect_string(__wrap_cJSON_AddStringToObject, name, "severity");
    expect_string(__wrap_cJSON_AddStringToObject, string, vu_severities[VU_HIGH]);
    expect_string(__wrap_cJSON_AddStringToObject, name, "published");
    expect_string(__wrap_cJSON_AddStringToObject, string, "2020-03-05T15:15:00Z");
    expect_string(__wrap_cJSON_AddStringToObject, name, "updated");
    expect_string(__wrap_cJSON_AddStringToObject, string, "2020-05-25T15:15:00Z");
    expect_string(__wrap_cJSON_AddStringToObject, name, "state");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->state);
    expect_string(__wrap_cJSON_AddStringToObject, name, "cwe_reference");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cwe);
    // Adding advisories data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "RHSA-2020:0975");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding bugzilla references data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "http://rhn.redhat.org/cgi-bin/bugreport.cgi?bug=925286");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding references data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "http://rhn.redhat.com/errata/RHSA-2016-2582.html");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_string(__wrap_cJSON_AddStringToObject, name, "assigner");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->assigner);
    expect_string(__wrap_cJSON_AddStringToObject, name, "cve_version");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cve_version);
    will_return(__wrap_cJSON_PrintUnformatted, json_text);

    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5468): The 'libhogweed4' package (3.4-1) from agent '001' is vulnerable to 'CVE-2016-6489'. Condition: 'Package less than 4.3-2'");

    will_return(__wrap_SendMSG, OS_SUCCESS);

    expect_function_call(__wrap_cJSON_Delete);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, OS_SUCCESS);
}

void test_wm_vuldet_send_cve_report_sendmsg_error(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    if (OS_INVALID == build_test_cve_report(report, 1, 1, 1, 0))
        return;

    cJSON* alert = (cJSON *)1;
    cJSON* alert_cve = (cJSON *)1;
    cJSON* j_package = (cJSON *)1;
    cJSON* j_cvss = (cJSON *)1;
    cJSON* j_cvss_node = (cJSON *)1;
    cJSON* cvss_json = (cJSON *)1;
    cJSON* j_advisories = (cJSON *)1;

    char *json_text = NULL;
    os_strdup("{\"title\": \"vulnerability detector alert json\"}", json_text);

    will_return_always(__wrap_cJSON_AddStringToObject, (cJSON *)1);

    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding package information
    will_return(__wrap_cJSON_CreateObject, j_package);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_string(__wrap_cJSON_AddStringToObject, name, "name");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->software);
    expect_string(__wrap_cJSON_AddStringToObject, name, "source");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->source);
    expect_string(__wrap_cJSON_AddStringToObject, name, "version");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->version);
    expect_string(__wrap_cJSON_AddStringToObject, name, "generated_cpe");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->generated_cpe);
    expect_string(__wrap_cJSON_AddStringToObject, name, "architecture");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->arch);
    expect_string(__wrap_cJSON_AddStringToObject, name, "condition");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->condition);
    // Adding cvss information
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "medium");
    expect_string(__wrap_cJSON_AddStringToObject, name, "authentication");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "complete");
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 7.1);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 8.6);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 6.9);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    will_return(__wrap_cJSON_CreateObject, cvss_json);
    expect_string(__wrap_cJSON_AddStringToObject, name, "attack_vector");
    expect_string(__wrap_cJSON_AddStringToObject, string, "network");
    expect_string(__wrap_cJSON_AddStringToObject, name, "access_complexity");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");
    expect_string(__wrap_cJSON_AddStringToObject, name, "privileges_required");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "user_interaction");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "scope");
    expect_string(__wrap_cJSON_AddStringToObject, string, "unchanged");
    expect_string(__wrap_cJSON_AddStringToObject, name, "confidentiality_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "integrity_impact");
    expect_string(__wrap_cJSON_AddStringToObject, string, "none");
    expect_string(__wrap_cJSON_AddStringToObject, name, "availability");
    expect_string(__wrap_cJSON_AddStringToObject, string, "high");
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 5.9);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 2.2);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_value(__wrap_cJSON_CreateNumber, num, 3.6);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding CVE information
    expect_string(__wrap_cJSON_AddStringToObject, name, "cve");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cve);
    expect_string(__wrap_cJSON_AddStringToObject, name, "title");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->title);
    expect_string(__wrap_cJSON_AddStringToObject, name, "rationale");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->rationale);
    expect_string(__wrap_cJSON_AddStringToObject, name, "severity");
    expect_string(__wrap_cJSON_AddStringToObject, string, vu_severities[VU_HIGH]);
    expect_string(__wrap_cJSON_AddStringToObject, name, "published");
    expect_string(__wrap_cJSON_AddStringToObject, string, "2020-03-05T15:15:00Z");
    expect_string(__wrap_cJSON_AddStringToObject, name, "updated");
    expect_string(__wrap_cJSON_AddStringToObject, string, "2020-05-25T15:15:00Z");
    expect_string(__wrap_cJSON_AddStringToObject, name, "state");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->state);
    expect_string(__wrap_cJSON_AddStringToObject, name, "cwe_reference");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cwe);
    // Adding advisories data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "RHSA-2020:0975");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding bugzilla references data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "http://rhn.redhat.org/cgi-bin/bugreport.cgi?bug=925286");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    // Adding references data
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    expect_string(__wrap_cJSON_CreateString, string, "http://rhn.redhat.com/errata/RHSA-2016-2582.html");
    expect_function_call(__wrap_cJSON_AddItemToArray);
    expect_function_call(__wrap_cJSON_AddItemToObject);
    expect_string(__wrap_cJSON_AddStringToObject, name, "assigner");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->assigner);
    expect_string(__wrap_cJSON_AddStringToObject, name, "cve_version");
    expect_string(__wrap_cJSON_AddStringToObject, string, report->cve_version);
    will_return(__wrap_cJSON_PrintUnformatted, json_text);

    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5468): The 'libhogweed4' package (3.4-1) from agent '001' is vulnerable to 'CVE-2016-6489'. Condition: 'Package less than 4.3-2'");
    will_return(__wrap_SendMSG, OS_INVALID);

    char* strerr = NULL;
    os_strdup("Error sending message", strerr);
    will_return(__wrap_strerror, strerr);

    expect_string(__wrap__merror, formatted_msg, "At wm_sendmsg(): Unable to send message to queue: (Error sending message)");

    will_return(__wrap_strerror, strerr);
    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(1210): Queue '/queue/ossec/queue' not accessible: 'Error sending message'");

    will_return(__wrap_StartMQ, -1);

    expect_string(__wrap__mterror_exit, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror_exit, formatted_msg, "(1211): Unable to access queue: '/queue/ossec/queue'. Giving up.");

    expect_function_call(__wrap_cJSON_Delete);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, OS_SUCCESS);

    os_free(strerr);
}

/* wm_vuldet_extract_advisories */

void test_wm_vuldet_extract_advisories_no_advisories(void **state)
{
    cJSON *advisories = NULL;

    references *refs = wm_vuldet_extract_advisories(advisories);

    assert_null(refs);
}

void test_wm_vuldet_extract_advisories(void **state)
{
    cJSON *advisories = __real_cJSON_CreateObject();
    cJSON *adv1 = __real_cJSON_CreateString("RHSA-2020:0975");
    cJSON *adv2 = __real_cJSON_CreateString("RHSA-2019:0974");
    __real_cJSON_AddItemToObject(advisories, "advisory", adv1);
    __real_cJSON_AddItemToObject(advisories, "advisory", adv2);

    references *refs = wm_vuldet_extract_advisories(advisories->child);

    assert_int_equal(2, refs->elements);
    assert_string_equal("RHSA-2020:0975", refs->values[0]);
    assert_string_equal("RHSA-2019:0974", refs->values[1]);

    free_strarray(refs->values);
    os_free(refs);
    __real_cJSON_Delete(advisories);
}

/* wm_vuldet_build_url */

void test_wm_vuldet_build_url(void **state)
{
    char* tmp_cve = NULL;
    os_strdup("CVE-2016-6489", tmp_cve);

    char* tmp_url = wm_vuldet_build_url(VU_BUILD_REF_CVE_RH, tmp_cve);

    assert_string_equal("https://access.redhat.com/security/cve/CVE-2016-6489", tmp_url);

    os_free(tmp_cve);
    os_free(tmp_url);
}

/* wm_vuldet_compare_pkg */

void test_wm_vuldet_compare_pkg_equal_id(void **state)
{
    cve_vuln_pkg *Pkg1 = state[PKG1_POS];
    cve_vuln_pkg *Pkg2 = state[PKG2_POS];

    Pkg1->nvd_cond->id = 1; // just a dummy ID
    Pkg2->nvd_cond->id = 1;

    int res = wm_vuldet_compare_pkg(Pkg1, Pkg2);

    assert_int_equal(res, 0);
}

void test_wm_vuldet_compare_pkg_different_id(void **state)
{
    cve_vuln_pkg *Pkg1 = state[PKG1_POS];
    cve_vuln_pkg *Pkg2 = state[PKG2_POS];

    Pkg1->nvd_cond->id = 1; // just a dummy ID
    Pkg2->nvd_cond->id = 2;

    int res = wm_vuldet_compare_pkg(Pkg1, Pkg2);

    assert_int_equal(res, -1);
}

void test_wm_vuldet_compare_pkg_equal_arch(void **state)
{
    cve_vuln_pkg *Pkg1 = state[PKG1_POS];
    cve_vuln_pkg *Pkg2 = state[PKG2_POS];

    os_strdup("x86", Pkg1->arch);
    os_strdup("x86", Pkg2->arch);

    int res = wm_vuldet_compare_pkg(Pkg1, Pkg2);

    assert_int_equal(res, 0);
}

void test_wm_vuldet_compare_pkg_different_arch(void **state)
{
    cve_vuln_pkg *Pkg1 = state[PKG1_POS];
    cve_vuln_pkg *Pkg2 = state[PKG2_POS];

    os_strdup("x86", Pkg1->arch);
    os_strdup("x64", Pkg2->arch);

    int res = wm_vuldet_compare_pkg(Pkg1, Pkg2);

    assert_int_equal(res, -1);
}

void test_wm_vuldet_compare_pkg_equal_version(void **state)
{
    cve_vuln_pkg *Pkg1 = state[PKG1_POS];
    cve_vuln_pkg *Pkg2 = state[PKG2_POS];

    os_strdup("1.1.1", Pkg1->version);
    os_strdup("1.1.1", Pkg2->version);

    int res = wm_vuldet_compare_pkg(Pkg1, Pkg2);

    assert_int_equal(res, 0);
}

void test_wm_vuldet_compare_pkg_different_version(void **state)
{
    cve_vuln_pkg *Pkg1 = state[PKG1_POS];
    cve_vuln_pkg *Pkg2 = state[PKG2_POS];

    os_strdup("1.1.1", Pkg1->version);
    os_strdup("1.1.2", Pkg2->version);

    int res = wm_vuldet_compare_pkg(Pkg1, Pkg2);

    assert_int_equal(res, -1);
}

void test_wm_vuldet_compare_pkg_equal_bin_name(void **state)
{
    cve_vuln_pkg *Pkg1 = state[PKG1_POS];
    cve_vuln_pkg *Pkg2 = state[PKG2_POS];

    os_strdup("bin_name1", Pkg1->bin_name);
    os_strdup("bin_name1", Pkg2->bin_name);

    int res = wm_vuldet_compare_pkg(Pkg1, Pkg2);

    assert_int_equal(res, 0);
}

void test_wm_vuldet_compare_pkg_different_bin_name(void **state)
{
    cve_vuln_pkg *Pkg1 = state[PKG1_POS];
    cve_vuln_pkg *Pkg2 = state[PKG2_POS];

    os_strdup("bin_name1", Pkg1->bin_name);
    os_strdup("bin_name2", Pkg2->bin_name);

    int res = wm_vuldet_compare_pkg(Pkg1, Pkg2);

    assert_int_equal(res, -1);
}

void test_wm_vuldet_compare_pkg_equal_src_name(void **state)
{
    cve_vuln_pkg *Pkg1 = state[PKG1_POS];
    cve_vuln_pkg *Pkg2 = state[PKG2_POS];

    os_strdup("src_name1", Pkg1->src_name);
    os_strdup("src_name1", Pkg2->src_name);

    int res = wm_vuldet_compare_pkg(Pkg1, Pkg2);

    assert_int_equal(res, 0);
}

void test_wm_vuldet_compare_pkg_different_src_name(void **state)
{
    cve_vuln_pkg *Pkg1 = state[PKG1_POS];
    cve_vuln_pkg *Pkg2 = state[PKG2_POS];

    os_strdup("src_name1", Pkg1->src_name);
    os_strdup("src_name2", Pkg2->src_name);

    int res = wm_vuldet_compare_pkg(Pkg1, Pkg2);

    assert_int_equal(res, -1);
}

void test_wm_vuldet_add_cve_node_add_error(void **state)
{
    cve_vuln_pkg *newPkg = state[PKG1_POS];

    char *cve = NULL;
    os_strdup("CVE-2016-6489", cve);

    OSHash *cve_table = (OSHash *)1;

    expect_string(__wrap_OSHash_Add, key, "CVE-2016-6489");
    will_return(__wrap_OSHash_Add, 0);

    int ret = wm_vuldet_add_cve_node(newPkg, cve, cve_table);

    assert_int_equal(OS_INVALID, ret);

    os_free(cve);
}

void test_wm_vuldet_add_cve_node_get_error(void **state)
{
    cve_vuln_pkg *Pkg = state[PKG1_POS];
    cve_vuln_pkg *newPkg = state[PKG2_POS];

    char *cve = NULL;
    os_strdup("CVE-2016-6489", cve);

    OSHash *cve_table = (OSHash *)1;

    expect_string(__wrap_OSHash_Add, key, "CVE-2016-6489");
    will_return(__wrap_OSHash_Add, 1);
    expect_string(__wrap_OSHash_Get, key, "CVE-2016-6489");
    will_return(__wrap_OSHash_Get, NULL);

    int ret = wm_vuldet_add_cve_node(newPkg, cve, cve_table);

    assert_int_equal(OS_INVALID, ret);

    os_free(cve);
}

void test_wm_vuldet_add_cve_node(void **state)
{
    cve_vuln_pkg *Pkg = state[PKG1_POS];
    cve_vuln_pkg *newPkg = state[PKG2_POS];

    os_strdup("src_name1", Pkg->src_name);
    os_strdup("src_name1", newPkg->src_name);

    // Deleting the nvd_cond and vuln_cond from Pkg to
    // force the creation and copy within the function
    os_free(Pkg->nvd_cond);
    os_free(Pkg->vuln_cond);

    os_strdup("1.1.2", newPkg->nvd_cond->start_version);
    os_strdup("5.5.2", newPkg->nvd_cond->end_version);
    os_strdup("AND", newPkg->nvd_cond->operator);
    os_strdup("fixed", newPkg->vuln_cond->state);
    os_strdup("less than", newPkg->vuln_cond->operation);
    os_strdup("5.5.2", newPkg->vuln_cond->operation_value);
    os_strdup("Package less than 5.5.2", newPkg->vuln_cond->condition);

    char *cve = NULL;
    os_strdup("CVE-2016-6489", cve);

    OSHash *cve_table = (OSHash *)1;

    expect_string(__wrap_OSHash_Add, key, "CVE-2016-6489");
    will_return(__wrap_OSHash_Add, 1);
    expect_string(__wrap_OSHash_Get, key, "CVE-2016-6489");
    will_return(__wrap_OSHash_Get, Pkg);

    int ret = wm_vuldet_add_cve_node(newPkg, cve, cve_table);

    assert_int_equal(ret, 1);

    os_free(cve);
}

void test_wm_vuldet_add_cve_node_not_found(void **state)
{
    cve_vuln_pkg *Pkg = state[PKG1_POS];
    cve_vuln_pkg *newPkg = state[PKG2_POS];

    os_strdup("src_name1", Pkg->src_name);
    os_strdup("src_name2", newPkg->src_name);

    char *cve = NULL;
    os_strdup("CVE-2016-6489", cve);

    OSHash *cve_table = (OSHash *)1;

    expect_string(__wrap_OSHash_Add, key, "CVE-2016-6489");
    will_return(__wrap_OSHash_Add, 1);
    expect_string(__wrap_OSHash_Get, key, "CVE-2016-6489");
    will_return(__wrap_OSHash_Get, Pkg);

    int ret = wm_vuldet_add_cve_node(newPkg, cve, cve_table);

    assert_int_equal(ret, 0);

    // Within the function, the newPkg was assigned as the next package
    // of Pkg. If we left the structure in this state, it will happen a
    // double-free during the teardown. So, cleaning the reference from next.
    Pkg->next = NULL;
    os_free(cve);
}

/*
* NOTE: This test case was designed just to exercise the cve node
*       memory release. But the verification was made by using valgrind
*       to see that there is not memory not being released.
*       We did it in this way because there is not an efective way
*       to verify from the code that a memory address saved in a pointer
*       variable is alredy released.
*/
void test_wm_vuldet_free_cve_node(void **state)
{
    cve_vuln_pkg *pkg = NULL;
    os_calloc(1, sizeof(cve_vuln_pkg), pkg);

    cve_vuln_pkg *next_pkg = NULL;
    os_calloc(1, sizeof(cve_vuln_pkg), next_pkg);

    cve_vuln_cond_NVD* nvd_cond1 = NULL;
    os_calloc(1, sizeof(cve_vuln_cond_NVD), nvd_cond1);

    cve_vuln_cond_NVD* nvd_cond2 = NULL;
    os_calloc(1, sizeof(cve_vuln_cond_NVD), nvd_cond2);

    cve_vuln_cond* vuln_cond1 = NULL;
    os_calloc(1, sizeof(cve_vuln_cond), vuln_cond1);

    cve_vuln_cond* vuln_cond2 = NULL;
    os_calloc(1, sizeof(cve_vuln_cond), vuln_cond2);

    if (!pkg || !next_pkg || !nvd_cond1 || !nvd_cond2 || !vuln_cond1 || !vuln_cond2) {
        os_free(vuln_cond1);
        os_free(vuln_cond2);
        os_free(nvd_cond1);
        os_free(nvd_cond2);
        os_free(pkg);
        os_free(next_pkg);
        return;
    }

    pkg->nvd_cond = nvd_cond1;
    pkg->vuln_cond = vuln_cond1;

    os_strdup("src_name1", pkg->src_name);
    os_strdup("bin_name1", pkg->bin_name);
    os_strdup("x64", pkg->arch);
    os_strdup("1:1.2.3-4.5.6", pkg->version);
    os_strdup("1:1.2.3-4.5.5", pkg->nvd_cond->start_version);
    os_strdup("1:1.2.3-4.5.7", pkg->nvd_cond->end_version);
    os_strdup("AND", pkg->nvd_cond->operator);
    os_strdup("fixed", pkg->vuln_cond->state);
    os_strdup("less than", pkg->vuln_cond->operation);
    os_strdup("1:1.2.3-4.5.7", pkg->vuln_cond->operation_value);
    os_strdup("Package less than 1:1.2.3-4.5.7", pkg->vuln_cond->condition);

    pkg->next = next_pkg;
    next_pkg->nvd_cond = nvd_cond2;
    next_pkg->vuln_cond = vuln_cond2;

    os_strdup("src_name1", next_pkg->src_name);
    os_strdup("bin_name1", next_pkg->bin_name);
    os_strdup("x64", next_pkg->arch);
    os_strdup("1:1.2.3-4.5.6", next_pkg->version);
    os_strdup("1:1.2.3-4.5.5", next_pkg->nvd_cond->start_version);
    os_strdup("1:1.2.3-4.5.7", next_pkg->nvd_cond->end_version);
    os_strdup("AND", next_pkg->nvd_cond->operator);
    os_strdup("fixed", next_pkg->vuln_cond->state);
    os_strdup("less than", next_pkg->vuln_cond->operation);
    os_strdup("1:1.2.3-4.5.7", next_pkg->vuln_cond->operation_value);
    os_strdup("Package less than 1:1.2.3-4.5.7", next_pkg->vuln_cond->condition);

    wm_vuldet_free_cve_node(pkg);

    pkg = NULL;
    next_pkg = NULL;
}

/* wm_vuldet_report_agent_vulnerabilities */

void test_wm_vuldet_report_agent_vulnerabilities_agent_info_NULL(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    int ret = wm_vuldet_report_agent_vulnerabilities(db, agent, NULL);
    assert_int_equal(ret, 0);

}

void test_wm_vuldet_report_agent_vulnerabilities_agent_windows_error(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    agent->info = 'T';
    agent->dist = FEED_WIN;
    will_return(__wrap_wm_vuldet_win_nvd_vulnerabilities, -1);

    int ret = wm_vuldet_report_agent_vulnerabilities(db, agent, NULL);
    assert_int_equal(ret, -1);

}

void test_wm_vuldet_report_agent_vulnerabilities_agent_windows_OK(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    agent->info = 'T';
    agent->dist = FEED_WIN;
    will_return(__wrap_wm_vuldet_win_nvd_vulnerabilities, 0);

    int ret = wm_vuldet_report_agent_vulnerabilities(db, agent, NULL);
    assert_int_equal(ret, 0);

}

void test_wm_vuldet_report_agent_vulnerabilities_agent_linux_create_hash_error(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = NULL;

    agent->info = 'T';
    agent->dist = FEED_CANONICAL;

    will_return(__wrap_OSHash_Create, 0);

    expect_string(__wrap__merror, formatted_msg, "(1290): Unable to create a new list (calloc).");

    int ret = wm_vuldet_report_agent_vulnerabilities(db, agent, NULL);
    assert_int_equal(ret, -1);

}

void test_wm_vuldet_report_agent_vulnerabilities_agent_linux_setSize_hash_error(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = NULL;

    agent->info = 'T';
    agent->dist = FEED_CANONICAL;

    will_return(__wrap_OSHash_Create, 1);
    will_return(__wrap_OSHash_setSize, 0);

    will_return(__wrap_OSHash_Clean, NULL);

    expect_string(__wrap__merror, formatted_msg, "(1290): Unable to create a new list (calloc).");

    int ret = wm_vuldet_report_agent_vulnerabilities(db, agent, NULL);
    assert_int_equal(ret, -1);

}

void test_wm_vuldet_report_agent_vulnerabilities_agent_linux_oval_vulnerabilities_error(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    agent->info = 'T';
    agent->dist = FEED_CANONICAL;

    will_return(__wrap_OSHash_Create, cve_table);
    will_return(__wrap_OSHash_setSize, cve_table);

    //test_wm_vuldet_linux_oval_vulnerabilities_error_prepare()
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5456): Analyzing OVAL vulnerabilities for agent '000'");

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5569): Couldn't get the packages of the agent '000'");

    will_return(__wrap_sqlite3_errmsg, "error");

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5503): SQL error: 'error'");

    will_return(__wrap_sqlite3_close_v2, SQLITE_OK);

    will_return(__wrap_OSHash_Clean, 0);

    int ret = wm_vuldet_report_agent_vulnerabilities(db, agent, NULL);
    assert_int_equal(ret, -1);

}

void test_wm_vuldet_report_agent_vulnerabilities_agent_linux_nvd_vulnerabilities_error(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    agent->info = 'T';
    agent->dist = FEED_DEBIAN;
    agent->dist_ver = FEED_JESSIE;

    will_return(__wrap_OSHash_Create, cve_table);
    will_return(__wrap_OSHash_setSize, cve_table);

    //test_wm_vuldet_linux_oval_vulnerabilities_one_row_no_data()
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5456): Analyzing OVAL vulnerabilities for agent '000'");

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);

    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    // building query
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "JESSIE");
    expect_value(__wrap_sqlite3_bind_int, a, 2);
    expect_value(__wrap_sqlite3_bind_int, b, 0);

    will_return(__wrap_sqlite3_step, SQLITE_ROW);

    // By assigning null to some values, the row should be skipped
    // and the code should ask for a new row
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "source");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "less than");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, "5.4.3");
    expect_value(__wrap_sqlite3_column_text, i, 7);
    will_return(__wrap_sqlite3_column_text, "10");

    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5457): The OVAL found a total of '0' potential vulnerabilities for agent '000'");
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5470): It took '0' seconds to 'find OVAL' vulnerabilities in agent '000'");

    will_return(__wrap_wm_vuldet_linux_nvd_vulnerabilities, -1);

    will_return(__wrap_OSHash_Clean, 0);

    int ret = wm_vuldet_report_agent_vulnerabilities(db, agent, NULL);
    assert_int_equal(ret, -1);

}

void test_wm_vuldet_report_agent_vulnerabilities_agent_linux_rm_false_positivies_error(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    agent->info = 'T';
    agent->dist = FEED_DEBIAN;
    agent->dist_ver = FEED_JESSIE;

    will_return(__wrap_OSHash_Create, cve_table);
    will_return(__wrap_OSHash_setSize, cve_table);

    //test_wm_vuldet_linux_oval_vulnerabilities_one_row_no_data()
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5456): Analyzing OVAL vulnerabilities for agent '000'");

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);

    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    // building query
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "JESSIE");
    expect_value(__wrap_sqlite3_bind_int, a, 2);
    expect_value(__wrap_sqlite3_bind_int, b, 0);

    will_return(__wrap_sqlite3_step, SQLITE_ROW);

    // By assigning null to some values, the row should be skipped
    // and the code should ask for a new row
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "source");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "less than");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, "5.4.3");
    expect_value(__wrap_sqlite3_column_int, i, 7);
    will_return(__wrap_sqlite3_column_int, 0);

    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5457): The OVAL found a total of '0' new potential vulnerabilities for agent '000'");
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5470): It took '0' seconds to 'find OVAL' vulnerabilities in agent '000'");

    will_return(__wrap_wm_vuldet_linux_nvd_vulnerabilities, 0);

    //wm_vuldet_linux_rm_false_positivies_error

    will_return(__wrap_OSHash_Clean, 0);

    int ret = wm_vuldet_report_agent_vulnerabilities(db, agent, NULL);
    assert_int_equal(ret, -1);

}

void test_wm_vuldet_report_agent_vulnerabilities_agent_linux_send_agent_report_error(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    OSHashNode* node = NULL;
    os_calloc(1, sizeof(OSHashNode), node);
    if (!node || (OS_INVALID == build_test_hash_node(node, VU_SRC_NVD|VU_SRC_OVAL)))
        return;

    agent->info = 'T';
    agent->dist = FEED_UBUNTU;
    agent->dist_ver = FEED_FOCAL;

    will_return(__wrap_OSHash_Create, cve_table);
    will_return(__wrap_OSHash_setSize, cve_table);

    //test_wm_vuldet_linux_oval_vulnerabilities_one_row_no_data()
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5456): Analyzing OVAL vulnerabilities for agent '000'");

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);

    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    // building query
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "JESSIE");
    expect_value(__wrap_sqlite3_bind_int, a, 2);
    expect_value(__wrap_sqlite3_bind_int, b, 0);

    will_return(__wrap_sqlite3_step, SQLITE_ROW);

    // By assigning null to some values, the row should be skipped
    // and the code should ask for a new row
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "source");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "less than");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, "5.4.3");
    expect_value(__wrap_sqlite3_column_int, i, 7);
    will_return(__wrap_sqlite3_column_int, 0);

    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5457): The OVAL found a total of '0' new potential vulnerabilities for agent '000'");
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5470): It took '0' seconds to 'find OVAL' vulnerabilities in agent '000'");

    will_return(__wrap_wm_vuldet_linux_nvd_vulnerabilities, 0);

    //wm_vuldet_linux_rm_false_positivies_OK()

    //wm_vuldet_send_agent_report_fill_report_nvd_cve_info_error()
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5466): Sending vulnerabilities report for agent '000'");
    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5578): Could not fill the report with the CVE info from the NVD for agent '000'");

    will_return(__wrap_OSHash_Begin, node);
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);
    will_return(__wrap_sqlite3_errmsg, "error");
    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5503): SQL error: 'error'");
    will_return(__wrap_sqlite3_close_v2, SQLITE_OK);

    will_return(__wrap_OSHash_Clean, 0);

    int ret = wm_vuldet_report_agent_vulnerabilities(db, agent, NULL);
    assert_int_equal(ret, -1);

    wm_vuldet_free_cve_node(node->data);
    os_free(node->key);
    os_free(node);

}

void test_wm_vuldet_report_agent_vulnerabilities_agent_linux_OK(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    agent_software *agent = *state;
    OSHash *cve_table = (OSHash *)1;

    wm_max_eps = 1000000;

    OSHashNode* node = NULL;
    os_calloc(1, sizeof(OSHashNode), node);
    if (!node || (OS_INVALID == build_test_hash_node(node, VU_SRC_NVD|VU_SRC_OVAL)))
        return;

    agent->info = 'T';
    agent->dist = FEED_UBUNTU;
    agent->dist_ver = FEED_FOCAL;

    will_return(__wrap_OSHash_Create, cve_table);
    will_return(__wrap_OSHash_setSize, cve_table);

    //test_wm_vuldet_linux_oval_vulnerabilities_one_row_no_data()
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5456): Analyzing OVAL vulnerabilities for agent '000'");

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);

    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    // building query
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "JESSIE");
    expect_value(__wrap_sqlite3_bind_int, a, 2);
    expect_value(__wrap_sqlite3_bind_int, b, 0);

    will_return(__wrap_sqlite3_step, SQLITE_ROW);

    // By assigning null to some values, the row should be skipped
    // and the code should ask for a new row
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "source");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, NULL);
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "less than");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, "5.4.3");
    expect_value(__wrap_sqlite3_column_int, i, 7);
    will_return(__wrap_sqlite3_column_int, 0);

    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5457): The OVAL found a total of '0' new potential vulnerabilities for agent '000'");
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5470): It took '0' seconds to 'find OVAL' vulnerabilities in agent '000'");

    will_return(__wrap_wm_vuldet_linux_nvd_vulnerabilities, 0);

    //test_wm_vuldet_linux_rm_false_positivies_OK()

    //test_wm_vuldet_send_agent_report_error_send_cve_report()
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5466): Sending vulnerabilities report for agent '000'");
    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5559): Could not send the 'CVE-2016-6489' report for 'libhogweed4' in the agent '000'");

    will_return(__wrap_OSHash_Begin, node);
    will_return_always(__wrap_sqlite3_bind_text, 0);
    // Query for oval data
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "The CVE title.");
    expect_value(__wrap_sqlite3_column_text, i, 1);
    will_return(__wrap_sqlite3_column_text, vu_severities[VU_HIGH]);
    expect_value(__wrap_sqlite3_column_text, i, 2);
    will_return(__wrap_sqlite3_column_text, "2017-04-14");
    expect_value(__wrap_sqlite3_column_text, i, 3);
    will_return(__wrap_sqlite3_column_text, "2017-07-01");
    expect_value(__wrap_sqlite3_column_text, i, 4);
    will_return(__wrap_sqlite3_column_text, "The CVE description or rationale.");
    expect_value(__wrap_sqlite3_column_text, i, 5);
    will_return(__wrap_sqlite3_column_text, "6.9");
    expect_value(__wrap_sqlite3_column_text, i, 6);
    will_return(__wrap_sqlite3_column_text, "3.6");
    expect_value(__wrap_sqlite3_column_text, i, 7);
    will_return(__wrap_sqlite3_column_text, "AV:N/AC:M/Au:N/C:N/I:N/A:C");
    expect_value(__wrap_sqlite3_column_text, i, 8);
    will_return(__wrap_sqlite3_column_text, "CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H");
    expect_value(__wrap_sqlite3_column_text, i, 9);
    will_return(__wrap_sqlite3_column_text, "CWE-502");
    //Query for oval references
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "http://rhn.redhat.com/errata/RHSA-2016-2582.html");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);
    //Query for oval bugzilla references
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "http://rhn.redhat.org/cgi-bin/bugreport.cgi?bug=925286");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);
    //Query for oval advisories
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "CVE-2016-6489");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_string(__wrap_sqlite3_bind_text, b, "FOCAL");
    will_return(__wrap_sqlite3_step, SQLITE_ROW);
    expect_value(__wrap_sqlite3_column_text, i, 0);
    will_return(__wrap_sqlite3_column_text, "RHSA-2020:0975");
    will_return(__wrap_sqlite3_step, SQLITE_DONE);
    // Sending CVE report
    will_return(__wrap_cJSON_CreateObject, NULL);
    will_return(__wrap_OSHash_Next, NULL);

    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5482): A total of '0' vulnerabilities have been reported for agent '000' thanks to the 'NVD' feed.");
    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5482): A total of '0' vulnerabilities have been reported for agent '000' thanks to the 'vendor' feed.");
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5469): A total of '0' vulnerabilities have been reported for agent '000'");
    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5470): It took '0' seconds to 'report' vulnerabilities in agent '000'");

    will_return(__wrap_OSHash_Clean, 0);

    int ret = wm_vuldet_report_agent_vulnerabilities(db, agent, NULL);
    assert_int_equal(ret, 0);

    wm_vuldet_free_cve_node(node->data);
    os_free(node->key);
    os_free(node);

}

/* wm_vuldet_discard_kernel_package */

void test_wm_vuldet_discard_kernel_package_redhat_no_kernel(void **state)
{
    agent_software *agent = *state;

    agent->dist = FEED_REDHAT;
    agent->dist_ver = FEED_REDHAT;
    char *name = "test";
    char *version = "0.0.0";
    char *arch = "x32";

    int ret = wm_vuldet_discard_kernel_package(agent, name, version, arch);
    assert_int_equal(ret, 0);

}

void test_wm_vuldet_discard_kernel_package_redhat_kernel(void **state)
{
    agent_software *agent = *state;

    agent->dist = FEED_REDHAT;
    agent->dist_ver = FEED_REDHAT;
    agent->arch = strdup("x86_64");
    agent->kernel_release = strdup("0.0.0.x86_64");

    char *name = "kernel";
    char *version = "0.0.0";
    char *arch = "x86_64";

    int ret = wm_vuldet_discard_kernel_package(agent, name, version, arch);
    assert_int_equal(ret, 0);

}

void test_wm_vuldet_discard_kernel_package_debian_family_no_linux_image(void **state)
{
    agent_software *agent = *state;

    agent->dist = FEED_DEBIAN;
    agent->dist_ver = FEED_JESSIE;

    agent->arch = strdup("x86_64");
    agent->kernel_release = strdup("0.0.0.x86_64");

    char *name = "test";
    char *version = "0.0.0";
    char *arch = "x86_64";

    int ret = wm_vuldet_discard_kernel_package(agent, name, version, arch);
    assert_int_equal(ret, 0);

}

void test_wm_vuldet_discard_kernel_package_debian_family_linux_image(void **state)
{
    agent_software *agent = *state;

    agent->dist = FEED_DEBIAN;
    agent->dist_ver = FEED_JESSIE;

    agent->arch = strdup("x86_64");
    agent->kernel_release = strdup("0.0.0.x86_64");

    char *name = "linux-image-0.0.0.x86_64";
    char *version = "0.0.0";
    char *arch = "x86_64";

    int ret = wm_vuldet_discard_kernel_package(agent, name, version, arch);
    assert_int_equal(ret, 0);

}

void test_wm_vuldet_discard_kernel_package_discard_kernel(void **state)
{
    agent_software *agent = *state;

    agent->dist = FEED_DEBIAN;
    agent->dist_ver = FEED_JESSIE;

    agent->arch = strdup("x86_64");
    agent->kernel_release = strdup("0.0.0.x86_64");

    char *name = "linux-image-test";
    char *version = "0.0.0";
    char *arch = "x86_64";

    expect_string(__wrap__mdebug2, formatted_msg, "(5574): Discarded Linux Kernel package 'test' (not running) for agent '000'");

    int ret = wm_vuldet_discard_kernel_package(agent, name, version, arch);
    assert_int_equal(ret, -1);

}

void test_wm_vuldet_discard_kernel_package_OK(void **state)
{
    agent_software *agent = *state;

    agent->dist = FEED_DEBIAN;
    agent->dist_ver = FEED_JESSIE;

    agent->arch = strdup("x86_64");
    agent->kernel_release = strdup("1.0.0.x86_64");

    char *name = "test_OK";
    char *version = "1.0.0";
    char *arch = "x86_64";

    int ret = wm_vuldet_discard_kernel_package(agent, name, version, arch);
    assert_int_equal(ret, 0);

}

int main(void) {
    const struct CMUnitTest tests[] = {
        //Tests wm_vuldet_get_oslinux
        cmocka_unit_test_setup_teardown(test_wm_vuldet_get_oslinux_info, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_get_oslinux_info_only_major, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_get_oslinux_info_only_release, setup_agent_software, teardown_agent_software),
        cmocka_unit_test(test_wm_vuldet_get_oslinux_info_null_agent),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_get_oslinux_info_request_invalid, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_get_oslinux_info_request_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_get_oslinux_info_request_empty, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_get_oslinux_info_request_parse_error, setup_agent_software, teardown_agent_software),
        //Tests vuldet_generate_os_and_kernel_package
        cmocka_unit_test_setup_teardown(test_wm_vuldet_generate_os_and_kernel_package_ubuntu, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_generate_os_and_kernel_package_debian, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_generate_os_and_kernel_package_redhat, setup_agent_software, teardown_agent_software),
        cmocka_unit_test(test_wm_vuldet_generate_os_and_kernel_package_null_db),
        cmocka_unit_test(test_wm_vuldet_generate_os_and_kernel_package_null_agent),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_generate_os_and_kernel_package_invalid_agent, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_generate_os_and_kernel_package_os_package_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_generate_os_and_kernel_package_kernel_package_error, setup_agent_software, teardown_agent_software),
        //Tests wm_checks_package_vulnerability
        cmocka_unit_test(test_wm_checks_package_vulnerability_no_version_b),
        cmocka_unit_test(test_wm_checks_package_vulnerability_big_version_a),
        cmocka_unit_test(test_wm_checks_package_vulnerability_big_version_b),
        cmocka_unit_test(test_wm_checks_package_vulnerability_lt_with_epoch),
        cmocka_unit_test(test_wm_checks_package_vulnerability_lt_no_epoch),
        cmocka_unit_test(test_wm_checks_package_vulnerability_lt_no_revision),
        cmocka_unit_test(test_wm_checks_package_vulnerability_lt_no_revision_and_score),
        cmocka_unit_test(test_wm_checks_package_vulnerability_le),
        cmocka_unit_test(test_wm_checks_package_vulnerability_eq),
        cmocka_unit_test(test_wm_checks_package_vulnerability_ge),
        cmocka_unit_test(test_wm_checks_package_vulnerability_gt),
        cmocka_unit_test(test_wm_checks_package_vulnerability_ne),
        //Tests wm_vuldet_linux_oval_vulnerabilities
        cmocka_unit_test_setup_teardown(test_wm_vuldet_linux_oval_vulnerabilities_error_prepare, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_linux_oval_vulnerabilities_error_prepare_rh, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_linux_oval_vulnerabilities_error_prepare_deb, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_linux_oval_vulnerabilities_error_step, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_linux_oval_vulnerabilities_step_done, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_linux_oval_vulnerabilities_one_row_no_data, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_linux_oval_vulnerabilities_one_row_bad_version, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_linux_oval_vulnerabilities_one_row_not_fixed, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_linux_oval_vulnerabilities_one_row_error_comparing, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_linux_oval_vulnerabilities_one_row_not_vulnerable, setup_agent_software, teardown_agent_software),
        //Tests wm_vuldet_build_nvd_report
        cmocka_unit_test(test_wm_vuldet_build_nvd_report_condition_both_including),
        cmocka_unit_test(test_wm_vuldet_build_nvd_report_condition_both_excluding),
        cmocka_unit_test(test_wm_vuldet_build_nvd_report_condition_start_including),
        cmocka_unit_test(test_wm_vuldet_build_nvd_report_condition_start_excluding),
        cmocka_unit_test(test_wm_vuldet_build_nvd_report_condition_end_including),
        cmocka_unit_test(test_wm_vuldet_build_nvd_report_condition_end_excluding),
        //Tests wm_vuldet_fill_report_nvd
        cmocka_unit_test(test_wm_vuldet_fill_report_nvd_cve_info_error_prepare),
        cmocka_unit_test(test_wm_vuldet_fill_report_nvd_cve_info_error_step),
        cmocka_unit_test(test_wm_vuldet_fill_report_nvd_cve_info_ok),
        cmocka_unit_test(test_wm_vuldet_fill_report_nvd_references_error_prepare),
        cmocka_unit_test(test_wm_vuldet_fill_report_nvd_references_error_step),
        cmocka_unit_test(test_wm_vuldet_fill_report_nvd_references_ok),
        cmocka_unit_test(test_wm_vuldet_fill_report_nvd_scoring_error_prepare),
        cmocka_unit_test(test_wm_vuldet_fill_report_nvd_scoring_error_step),
        cmocka_unit_test(test_wm_vuldet_fill_report_nvd_scoring_cvss3_sev_crucial),
        cmocka_unit_test(test_wm_vuldet_fill_report_nvd_scoring_cvss3_sev_high),
        cmocka_unit_test(test_wm_vuldet_fill_report_nvd_scoring_cvss3_sev_medium),
        cmocka_unit_test(test_wm_vuldet_fill_report_nvd_scoring_cvss3_sev_low),
        cmocka_unit_test(test_wm_vuldet_fill_report_nvd_scoring_cvss3_sev_none),
        cmocka_unit_test(test_wm_vuldet_fill_report_nvd_scoring_cvss2_sev_high),
        cmocka_unit_test(test_wm_vuldet_fill_report_nvd_scoring_cvss2_sev_medium),
        cmocka_unit_test(test_wm_vuldet_fill_report_nvd_scoring_cvss2_sev_low),
        cmocka_unit_test(test_wm_vuldet_fill_report_nvd_scoring_sev_unknown),
        //Tests wm_vuldet_fill_report_oval_data
        cmocka_unit_test_setup_teardown(test_wm_vuldet_fill_report_oval_data_prepare_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_fill_report_oval_data_references_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_fill_report_oval_data_bugzilla_references_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_fill_report_oval_data_advisories_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_fill_report_oval_data, setup_agent_software, teardown_agent_software),
        //Tests wm_vuldet_send_agent_report
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_agent_report_no_hash_node_rh, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_agent_report_no_hash_node_ubuntu, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_agent_report_fill_report_nvd_cve_info_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_agent_report_fill_report_nvd_references_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_agent_report_fill_report_nvd_scoring_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_agent_report_fill_report_oval_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_agent_send_cve_report, setup_agent_software, teardown_agent_software),
        //Tests test_wm_vuldet_get_cvss
        cmocka_unit_test(test_wm_vuldet_get_cvss_null),
        cmocka_unit_test(test_wm_vuldet_get_cvss_error_cvss_json),
        cmocka_unit_test(test_wm_vuldet_get_cvss_attack_vector_local),
        cmocka_unit_test(test_wm_vuldet_get_cvss_attack_vector_adjacent_network),
        cmocka_unit_test(test_wm_vuldet_get_cvss_attack_vector_network),
        cmocka_unit_test(test_wm_vuldet_get_cvss_attack_vector_physiscal),
        cmocka_unit_test(test_wm_vuldet_get_cvss_access_complexity_low),
        cmocka_unit_test(test_wm_vuldet_get_cvss_access_complexity_medium),
        cmocka_unit_test(test_wm_vuldet_get_cvss_access_complexity_high),
        cmocka_unit_test(test_wm_vuldet_get_cvss_authentication_multiple),
        cmocka_unit_test(test_wm_vuldet_get_cvss_authentication_single),
        cmocka_unit_test(test_wm_vuldet_get_cvss_authentication_none),
        cmocka_unit_test(test_wm_vuldet_get_cvss_confidentiality_impact_none),
        cmocka_unit_test(test_wm_vuldet_get_cvss_confidentiality_impact_partial),
        cmocka_unit_test(test_wm_vuldet_get_cvss_confidentiality_impact_complete),
        cmocka_unit_test(test_wm_vuldet_get_cvss_confidentiality_impact_low),
        cmocka_unit_test(test_wm_vuldet_get_cvss_confidentiality_impact_high),
        cmocka_unit_test(test_wm_vuldet_get_cvss_user_interaction_none),
        cmocka_unit_test(test_wm_vuldet_get_cvss_user_interaction_required),
        cmocka_unit_test(test_wm_vuldet_get_cvss_integrity_impact_none),
        cmocka_unit_test(test_wm_vuldet_get_cvss_integrity_impact_partial),
        cmocka_unit_test(test_wm_vuldet_get_cvss_integrity_impact_complete),
        cmocka_unit_test(test_wm_vuldet_get_cvss_integrity_impact_low),
        cmocka_unit_test(test_wm_vuldet_get_cvss_integrity_impact_high),
        cmocka_unit_test(test_wm_vuldet_get_cvss_availability_none),
        cmocka_unit_test(test_wm_vuldet_get_cvss_availability_partial),
        cmocka_unit_test(test_wm_vuldet_get_cvss_availability_complete),
        cmocka_unit_test(test_wm_vuldet_get_cvss_availability_low),
        cmocka_unit_test(test_wm_vuldet_get_cvss_availability_high),
        cmocka_unit_test(test_wm_vuldet_get_cvss_privileges_required_none),
        cmocka_unit_test(test_wm_vuldet_get_cvss_privileges_required_partial),
        cmocka_unit_test(test_wm_vuldet_get_cvss_privileges_required_complete),
        cmocka_unit_test(test_wm_vuldet_get_cvss_privileges_required_low),
        cmocka_unit_test(test_wm_vuldet_get_cvss_privileges_required_high),
        cmocka_unit_test(test_wm_vuldet_get_cvss_scope_unchanged),
        cmocka_unit_test(test_wm_vuldet_get_cvss_scope_changed),
        cmocka_unit_test(test_wm_vuldet_get_cvss_v2),
        cmocka_unit_test(test_wm_vuldet_get_cvss_v3),
        //Tests wm_vuldet_send_cve_report
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_error_alert_create, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_error_alert_cve_create, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_error_j_package_create, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_error_j_cvss_create, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_error_j_cvss_node_create, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_error_j_advisories_create, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_error_j_bug_references_create, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_error_j_references_create, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_without_title, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_without_condition, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_without_ip, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_without_hotfix, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_sendmsg_error, setup_cve_report, teardown_cve_report),
        //Tests wm_vuldet_extract_advisories
        cmocka_unit_test(test_wm_vuldet_extract_advisories_no_advisories),
        cmocka_unit_test(test_wm_vuldet_extract_advisories),
        //Tests wm_vuldet_build_url
        cmocka_unit_test(test_wm_vuldet_build_url),
        //Tests wm_vuldet_compare_pkg
        cmocka_unit_test_setup_teardown(test_wm_vuldet_compare_pkg_equal_id, setup_package_comparison, teardown_package_comparison),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_compare_pkg_different_id, setup_package_comparison, teardown_package_comparison),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_compare_pkg_equal_arch, setup_package_comparison, teardown_package_comparison),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_compare_pkg_different_arch, setup_package_comparison, teardown_package_comparison),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_compare_pkg_equal_version, setup_package_comparison, teardown_package_comparison),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_compare_pkg_different_version, setup_package_comparison, teardown_package_comparison),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_compare_pkg_equal_bin_name, setup_package_comparison, teardown_package_comparison),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_compare_pkg_different_bin_name, setup_package_comparison, teardown_package_comparison),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_compare_pkg_equal_src_name, setup_package_comparison, teardown_package_comparison),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_compare_pkg_different_src_name, setup_package_comparison, teardown_package_comparison),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_add_cve_node_add_error, setup_package_comparison, teardown_package_comparison),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_add_cve_node_get_error, setup_package_comparison, teardown_package_comparison),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_add_cve_node, setup_package_comparison, teardown_package_comparison),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_add_cve_node_not_found, setup_package_comparison, teardown_package_comparison),
        //Tests wm_vuldet_free_cve_node
        cmocka_unit_test(test_wm_vuldet_free_cve_node),
        //Tests wm_vuldet_report_agent_vulnerabilities
        cmocka_unit_test_setup_teardown(test_wm_vuldet_report_agent_vulnerabilities_agent_info_NULL, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_report_agent_vulnerabilities_agent_windows_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_report_agent_vulnerabilities_agent_windows_OK, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_report_agent_vulnerabilities_agent_linux_create_hash_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_report_agent_vulnerabilities_agent_linux_setSize_hash_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_report_agent_vulnerabilities_agent_linux_oval_vulnerabilities_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_report_agent_vulnerabilities_agent_linux_nvd_vulnerabilities_error, setup_agent_software, teardown_agent_software),
        //cmocka_unit_test_setup_teardown(test_wm_vuldet_report_agent_vulnerabilities_agent_linux_rm_false_positivies_error, setup_agent_software, teardown_agent_software)
        //cmocka_unit_test_setup_teardown(test_wm_vuldet_report_agent_vulnerabilities_agent_linux_send_agent_report_error, setup_agent_software, teardown_agent_software)
        //cmocka_unit_test_setup_teardown(test_wm_vuldet_report_agent_vulnerabilities_agent_linux_OK, setup_agent_software, teardown_agent_software)
        cmocka_unit_test_setup_teardown(test_wm_vuldet_discard_kernel_package_redhat_no_kernel, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_discard_kernel_package_redhat_kernel, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_discard_kernel_package_debian_family_no_linux_image, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_discard_kernel_package_debian_family_linux_image, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_discard_kernel_package_discard_kernel, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_discard_kernel_package_OK, setup_agent_software, teardown_agent_software)
    };
    return cmocka_run_group_tests(tests, NULL, NULL);
}
